<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Ticket Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas for screenshot functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f7ff; /* Light Blue */
            color: #1e3a8a; /* Dark Blue */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for active tab */
        .tab-active {
            border-bottom-color: #1d4ed8; /* Dark Blue */
            color: #1d4ed8; /* Dark Blue */
        }
        /* Notification toast animation */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .toast {
            animation: fadeInOut 4s ease-in-out forwards;
        }
        /* Priority colors */
        .priority-P1 { background-color: #fee2e2; color: #dc2626; }
        .priority-P2 { background-color: #fed7aa; color: #ea580c; }
        .priority-P3 { background-color: #fef08a; color: #ca8a04; }
        .priority-P4 { background-color: #dbeafe; color: #1d4ed8; }
        /* Text truncation for table cells */
        .truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .truncate-description {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Dropdown menu styles */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            min-width: 120px;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        .dropdown-item.resolve {
            color: #059669;
        }
        .dropdown-item.edit {
            color: #2563eb;
        }
        /* Add contrasting background for text areas */
        textarea {
            background-color: #f8fafc; /* Light gray background */
            color: #1e293b; /* Dark slate text color */
            border: 1px solid #cbd5e1; /* Border color */
        }
        
        textarea:focus {
            background-color: #ffffff; /* White when focused */
            outline: 2px solid #3b82f6; /* Blue focus ring */
            outline-offset: -1px;
        }
        /* New Ticket Modal Color Scheme */
        .modal-label {
            font-weight: 700;
            color: #1e3a8a; /* Dark Blue */
            font-size: 0.875rem;
        }
        .modal-input, .modal-select, .modal-textarea {
            background-color: #f0f7ff; /* Light Blue */
            color: #1e3a8a; /* Dark Blue */
            border: 1px solid #bfdbfe; /* Light Blue Border */
            border-radius: 0.375rem;
        }
        .modal-input:focus, .modal-select:focus, .modal-textarea:focus {
            background-color: #ffffff; /* White when focused */
            outline: 2px solid #1d4ed8; /* Dark Blue focus ring */
            outline-offset: -1px;
            border-color: #1d4ed8;
        }
        .modal-header {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 700;
        }
        .modal-save-btn {
            background-color: #1d4ed8; /* Dark Blue */
            color: white;
        }
        .modal-save-btn:hover {
            background-color: #1e40af; /* Darker Blue */
        }
        .modal-cancel-btn {
            background-color: #f1f5f9; /* Light Gray */
            color: #475569; /* Slate Gray */
        }
        .modal-cancel-btn:hover {
            background-color: #e2e8f0; /* Slightly Darker Gray */
        }
        .modal-delete-btn {
            background-color: #dc2626; /* Red */
            color: white;
        }
        .modal-delete-btn:hover {
            background-color: #b91c1c; /* Darker Red */
        }
        /* Chart container styles */
        .chart-container {
            height: 300px;
            position: relative;
        }
        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover {
            background-color: #f3f4f6;
        }
        .pagination-btn.active {
            background-color: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-info {
            margin: 0 1rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        /* label styles */
        .enhanced-label {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        .section-header {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .filter-label {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 600;
            font-size: 0.75rem;
        }
        /* Report period display */
        .report-period {
            background-color: #dbeafe;
            color: #1e3a8a;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
            border-left: 4px solid #1d4ed8;
        }
        /* Screenshot button */
        .screenshot-btn {
            background-color: #059669;
            color: white;
        }
        .screenshot-btn:hover {
            background-color: #047857;
        }
        /* User presence indicator */
        .user-presence {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981; /* Green for online */
        }
        .user-status.offline {
            background-color: #6b7280; /* Gray for offline */
        }
        .online-users {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            z-index: 40;
            max-width: 200px;
        }
        .online-users-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e3a8a;
        }
        .online-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* Edit conflict modal */
        .edit-conflict-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .edit-conflict-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
        }
        /* Real-time update indicator */
        .real-time-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            z-index: 50;
            display: none;
        }
        /* Turnover section styles - UPDATED */
        .turnover-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .turnover-section-header {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid;
            padding-bottom: 0.5rem;
        }
        .turnover-item {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .turnover-item:last-child {
            border-bottom: none;
        }
        .turnover-item-content {
            flex-grow: 1;
            white-space: pre-line; /* Preserve line breaks */
        }
        .turnover-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        .turnover-add-btn {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .turnover-add-btn:hover {
            opacity: 0.9;
        }
        .turnover-input-group {
            margin-bottom: 1rem;
        }
        /* Hide edit/delete buttons during screenshot */
        .screenshot-mode .turnover-item-actions {
            display: none !important;
        }
        .screenshot-mode .turnover-input-group {
            display: none !important;
        }
        .screenshot-mode #takeTurnoverScreenshotBtn {
            display: none !important;
        }
        .screenshot-mode #saveTurnoverBtn {
            display: none !important;
        }
        /* Environment label colors */
        .environment-Prod { background-color: #dcfce7; color: #166534; }
        .environment-UAT { background-color: #fef3c7; color: #92400e; }
        .environment-N\/A { background-color: #e5e7eb; color: #4b5563; }
        /* Compact export button */
        .compact-export-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
        /* COMPACT FILTER STYLES */
        .compact-filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .compact-filter-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #1e3a8a;
            white-space: nowrap;
            margin-right: 0.25rem;
        }
        .compact-filter-select {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            border-radius: 0.25rem;
            border: 1px solid #cbd5e1;
            min-width: 80px;
        }
        .compact-filter-date {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            border-radius: 0.25rem;
            border: 1px solid #cbd5e1;
            width: 110px;
        }
        .compact-export-container {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: auto;
        }
        .compact-export-select {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            border-radius: 0.25rem;
            border: 1px solid #cbd5e1;
        }

        /* NEW: Turnover section-specific color schemes */
        .turnover-date-section {
            background-color: #e0f2fe; /* Light blue */
        }
        .turnover-date-section .turnover-section-header {
            color: #0369a1; /* Darker blue */
            border-bottom-color: #0369a1;
        }

        /* UPDATED: Tickets Handled section with new color scheme */
        .turnover-tickets-section {
            background-color: #f0fdf4; /* Light green */
        }
        .turnover-tickets-section .turnover-section-header {
            color: #15803d; /* Darker green */
            border-bottom-color: #15803d;
        }
        /* NEW: Color scheme for tickets handled boxes */
        .tickets-in-progress-box {
            background-color: #fef3c7; /* Light amber */
            border-left: 4px solid #d97706; /* Amber border */
        }
        .tickets-resolved-box {
            background-color: #dbeafe; /* Light blue */
            border-left: 4px solid #1d4ed8; /* Blue border */
        }
        .tickets-in-progress-count {
            color: #92400e; /* Dark amber */
        }
        .tickets-resolved-count {
            color: #1e40af; /* Dark blue */
        }
        .tickets-in-progress-label {
            color: #92400e; /* Dark amber */
        }
        .tickets-resolved-label {
            color: #1e40af; /* Dark blue */
        }

        .turnover-scheduled-section {
            background-color: #fefce8; /* Light yellow */
        }
        .turnover-scheduled-section .turnover-section-header {
            color: #a16207; /* Darker yellow/brown */
            border-bottom-color: #a16207;
        }

        .turnover-general-section {
            background-color: #fef7ff; /* Light purple */
        }
        .turnover-general-section .turnover-section-header {
            color: #7e22ce; /* Darker purple */
            border-bottom-color: #7e22ce;
        }

        .turnover-reminders-section {
            background-color: #fff1f2; /* Light pink */
        }
        .turnover-reminders-section .turnover-section-header {
            color: #be123c; /* Darker pink/red */
            border-bottom-color: #be123c;
        }

        .turnover-oncall-section {
            background-color: #f0f9ff; /* Light blue */
        }
        .turnover-oncall-section .turnover-section-header {
            color: #0c4a6e; /* Darker blue */
            border-bottom-color: #0c4a6e;
        }

        /* Turnover text areas */
        .turnover-textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #cbd5e1;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        /* Turnover labels */
        .turnover-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.875rem;
        }

        /* Color schemes for Reports tab charts */
        .chart-card {
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .trend-chart {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .trend-chart::before {
            background: linear-gradient(90deg, #0ea5e9, #0369a1);
        }

        .shift-chart {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .shift-chart::before {
            background: linear-gradient(90deg, #22c55e, #15803d);
        }

        .status-chart {
            background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 100%);
        }

        .status-chart::before {
            background: linear-gradient(90deg, #a855f7, #7e22ce);
        }

        .issue-chart {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        }

        .issue-chart::before {
            background: linear-gradient(90deg, #f97316, #c2410c);
        }

        .priority-chart {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .priority-chart::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .environment-chart {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        }

        .environment-chart::before {
            background: linear-gradient(90deg, #eab308, #a16207);
        }

        .stats-card {
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stats-resolved {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .stats-resolved::before {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        .stats-in-progress {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .stats-in-progress::before {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }

        .stats-age {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        }

        .stats-age::before {
            background: linear-gradient(90deg, #eab308, #ca8a04);
        }

        /* NEW: User Selection Modal Styles */
        .user-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .user-selection-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .user-selection-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 1.5rem;
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .user-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-option:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .user-option.selected {
            border-color: #1d4ed8;
            background-color: #eff6ff;
        }
        .user-option-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .user-option-name {
            font-weight: 600;
            color: #1e3a8a;
        }

        /* NEW: Clear filter button styles */
        .clear-filter-btn {
            background-color: #6b7280;
            color: white;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .clear-filter-btn:hover {
            background-color: #4b5563;
        }
        
        .team-selection {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- NEW: User Selection Modal -->
    <div id="userSelectionModal" class="user-selection-modal hidden">
        <div class="user-selection-content">
            <h2 class="user-selection-title">Select Your Username</h2>
            <div id="userOptionsGrid" class="user-grid">
                <!-- User options will be populated by JavaScript -->
            </div>
            <button id="confirmUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 w-full">
                Confirm Selection
            </button>
        </div>
    </div>

    <!-- Real-time Update Indicator -->
    <div id="realTimeIndicator" class="real-time-indicator">
        <span id="updateMessage">Update received</span>
    </div>

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-900">Ticket Tracker</h1>
            <div class="mt-4 sm:mt-0 flex items-center gap-4">
                <div class="user-presence">
                    <div id="currentUserAvatar" class="user-avatar bg-blue-600">U</div>
                    <span id="currentUserName" class="text-sm font-medium">User</span>
                    <div id="currentUserStatus" class="user-status"></div>
                </div>
                <button id="addTicketBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    + New Ticket
                </button>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="in-progress">
                    In Progress
                </button>
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="resolved">
                    Resolved
                </button>
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="turnover">
                    Turnover
                </button>
                <!-- NEW: Past Turnover Tab -->
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="past-turnover">
                    Past Turnover
                </button>
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="reports">
                    Reports
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- In Progress Tickets -->
            <div id="in-progress-content" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">In Progress Tickets</h2>
                    
                    <!-- UPDATED: Compact filter and export controls with clear filter button -->
                    <div class="compact-filter-container mb-4">
                        <span class="compact-filter-label">Sort by:</span>
                        <select id="sort-in-progress-date" class="compact-filter-select">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                        <select id="sort-in-progress-shift" class="compact-filter-select">
                            <option value="default">All Shifts</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                        <select id="sort-in-progress-assignee" class="compact-filter-select">
                            <option value="default">All Assignees</option>
                        </select>
                        <select id="sort-in-progress-priority" class="compact-filter-select">
                            <option value="default">All Priorities</option>
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                        </select>
                        <select id="sort-in-progress-environment" class="compact-filter-select">
                            <option value="default">All Environments</option>
                            <option value="Prod">Prod</option>
                            <option value="UAT">UAT</option>
                            <option value="N/A">N/A</option>
                        </select>
                        <select id="sort-in-progress-issue" class="compact-filter-select">
                            <option value="default">All Issues</option>
                            <option value="Zena Failed Jobs - BPI">Zena Failed Jobs - BPI</option>
                            <option value="Zena Failed Jobs - DB">Zena Failed Jobs - DB</option>
                            <option value="Netcool Alert">Netcool Alert</option>
                            <option value="PagerDuty Alert">PagerDuty Alert</option>
                            <option value="PowerBroker (SDDC)">PowerBroker (SDDC)</option>
                            <option value="PowerBroker (Cloud AWS)">PowerBroker (Cloud AWS)</option>
                            <option value="CSOC - Phishing Email">CSOC - Phishing Email</option>
                            <option value="Service Request - Data Center Access">Service Request - Data Center Access</option>
                        </select>
                        <input type="date" id="filter-in-progress-specific-date" class="compact-filter-date">
                        
                        <!-- NEW: Clear Filter Button for In Progress -->
                        <button id="clearInProgressFilter" class="clear-filter-btn">Clear Filters</button>
                        
                        <div class="compact-export-container">
                            <span class="compact-filter-label">Export:</span>
                            <select id="exportInProgressPeriod" class="compact-export-select">
                                <option value="day">Today</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                            <button id="exportInProgressBtn" class="compact-export-btn bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-transform transform hover:scale-105">
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Shift</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Handled By</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Ticket #</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Priority</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Environment</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Status</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Issue/Request</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Description</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolution</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Age</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="in-progress-tickets-table" class="divide-y divide-gray-200">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination for In Progress -->
                    <div id="in-progress-pagination" class="pagination mt-4 hidden">
                        <!-- Pagination buttons will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Resolved Tickets -->
            <div id="resolved-content" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Resolved Tickets</h2>
                    
                    <!-- UPDATED: Compact filter and export controls with clear filter button -->
                    <div class="compact-filter-container mb-4">
                        <span class="compact-filter-label">Sort by:</span>
                        <select id="sort-resolved-date" class="compact-filter-select">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                        <select id="sort-resolved-shift" class="compact-filter-select">
                            <option value="default">All Shifts</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                        <select id="sort-resolved-assignee" class="compact-filter-select">
                            <option value="default">All Assignees</option>
                        </select>
                        <select id="sort-resolved-priority" class="compact-filter-select">
                            <option value="default">All Priorities</option>
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                        </select>
                        <select id="sort-resolved-environment" class="compact-filter-select">
                            <option value="default">All Environments</option>
                            <option value="Prod">Prod</option>
                            <option value="UAT">UAT</option>
                            <option value="N/A">N/A</option>
                        </select>
                        <select id="sort-resolved-issue" class="compact-filter-select">
                            <option value="default">All Issues</option>
                            <option value="Zena Failed Jobs - BPI">Zena Failed Jobs - BPI</option>
                            <option value="Zena Failed Jobs - DB">Zena Failed Jobs - DB</option>
                            <option value="Netcool Alert">Netcool Alert</option>
                            <option value="PagerDuty Alert">PagerDuty Alert</option>
                            <option value="PowerBroker (SDDC)">PowerBroker (SDDC)</option>
                            <option value="PowerBroker (Cloud AWS)">PowerBroker (Cloud AWS)</option>
                            <option value="CSOC - Phishing Email">CSOC - Phishing Email</option>
                            <option value="Service Request - Data Center Access">Service Request - Data Center Access</option>
                        </select>
                        <input type="date" id="filter-resolved-specific-date" class="compact-filter-date">
                        
                        <!-- NEW: Clear Filter Button for Resolved -->
                        <button id="clearResolvedFilter" class="clear-filter-btn">Clear Filters</button>
                        
                        <div class="compact-export-container">
                            <span class="compact-filter-label">Export:</span>
                            <select id="exportResolvedPeriod" class="compact-export-select">
                                <option value="day">Today</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                            <button id="exportResolvedBtn" class="compact-export-btn bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-transform transform hover:scale-105">
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                         <table class="min-w-full bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Shift</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Handled By</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Ticket #</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Priority</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Environment</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Issue/Request</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Description</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolution</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolved On</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resolved-tickets-table" class="divide-y divide-gray-200">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination for Resolved -->
                    <div id="resolved-pagination" class="pagination mt-4 hidden">
                        <!-- Pagination buttons will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- NEW: Turnover Tab - UPDATED -->
            <div id="turnover-content" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Turnover</h2>
                    <div class="flex gap-2 mb-4">
                        <button id="takeTurnoverScreenshotBtn" class="screenshot-btn font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                            Take Turnover Screenshot
                        </button>
                        <!-- NEW: Save Turnover Button -->
                        <button id="saveTurnoverBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                            Save Turnover
                        </button>
                    </div>
                    
                    <!-- Section 1: Date and Shift - UPDATED WITH TEAM SELECTION -->
                    <div class="turnover-section turnover-date-section">
                        <h3 class="turnover-section-header">Date and Shift</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="turnover-input-group">
                                <label for="turnover-date" class="turnover-label">Date</label>
                                <input type="date" id="turnover-date" class="w-full p-2 border rounded-md">
                            </div>
                            <div class="turnover-input-group">
                                <label for="turnover-shift" class="turnover-label">Shift</label>
                                <select id="turnover-shift" class="w-full p-2 border rounded-md">
                                    <option value="" disabled selected>Select Shift</option>
                                    <option value="Day Shift">Day Shift</option>
                                    <option value="Night Shift">Night Shift</option>
                                </select>
                            </div>
                        </div>
                        <!-- Team Selection -->
                        <div class="team-selection">
                            <label for="turnover-team" class="turnover-label">Team</label>
                            <select id="turnover-team" class="w-full p-2 border rounded-md">
                                <option value="" disabled selected>Select Team</option>
                                <option value="A">Team A</option>
                                <option value="B">Team B</option>
                                <option value="C">Team C</option>
                                <option value="D">Team D</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Section 2: Tickets Handled - UPDATED WITH NEW COLOR SCHEME -->
                    <div class="turnover-section turnover-tickets-section">
                        <h3 class="turnover-section-header">Tickets Handled</h3>
                        <div id="turnover-tickets-container">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold text-amber-800 mb-2">In Progress Tickets</h4>
                                    <div id="turnover-in-progress-count" class="tickets-in-progress-box p-4 rounded-md text-center">
                                        <div class="text-3xl font-bold tickets-in-progress-count">0</div>
                                        <div class="text-sm tickets-in-progress-label">Tickets</div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Resolved Tickets</h4>
                                    <div id="turnover-resolved-count" class="tickets-resolved-box p-4 rounded-md text-center">
                                        <div class="text-3xl font-bold tickets-resolved-count">0</div>
                                        <div class="text-sm tickets-resolved-label">Tickets</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Scheduled Events - UPDATED -->
                    <div class="turnover-section turnover-scheduled-section">
                        <h3 class="turnover-section-header">Scheduled Events</h3>
                        <div id="turnover-scheduled-events">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <label for="new-scheduled-event" class="turnover-label">Add New Scheduled Event</label>
                            <textarea id="new-scheduled-event" placeholder="Enter scheduled event details..." class="turnover-textarea"></textarea>
                            <button id="add-scheduled-event" class="turnover-add-btn bg-amber-600">Add Event</button>
                        </div>
                    </div>
                    
                    <!-- Section 4: General Information - UPDATED -->
                    <div class="turnover-section turnover-general-section">
                        <h3 class="turnover-section-header">General Information</h3>
                        <div id="turnover-general-info">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <label for="new-general-info" class="turnover-label">Add New General Information</label>
                            <textarea id="new-general-info" placeholder="Enter general information..." class="turnover-textarea"></textarea>
                            <button id="add-general-info" class="turnover-add-btn bg-purple-600">Add Information</button>
                        </div>
                    </div>
                    
                    <!-- Section 5: Reminders - UPDATED -->
                    <div class="turnover-section turnover-reminders-section">
                        <h3 class="turnover-section-header">Reminders</h3>
                        <div id="turnover-reminders">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <label for="new-reminder" class="turnover-label">Add New Reminder</label>
                            <textarea id="new-reminder" placeholder="Enter reminder details..." class="turnover-textarea"></textarea>
                            <button id="add-reminder" class="turnover-add-btn bg-pink-600">Add Reminder</button>
                        </div>
                    </div>
                    
                    <!-- Section 6: On-call Updates - UPDATED -->
                    <div class="turnover-section turnover-oncall-section">
                        <h3 class="turnover-section-header">On-call Updates</h3>
                        <div id="turnover-oncall-updates">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <label for="new-oncall-update" class="turnover-label">Add New On-call Update</label>
                            <textarea id="new-oncall-update" placeholder="Enter on-call update details..." class="turnover-textarea"></textarea>
                            <button id="add-oncall-update" class="turnover-add-btn bg-sky-700">Add Update</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Past Turnover Tab Content - UPDATED WITH TEAM COLUMN -->
            <div id="past-turnover-content" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Past Turnover</h2>
                    
                    <!-- Filter Controls -->
                    <div class="compact-filter-container mb-4">
                        <span class="compact-filter-label">Filter by:</span>
                        <input type="date" id="filter-past-turnover-date" class="compact-filter-date">
                        <select id="filter-past-turnover-shift" class="compact-filter-select">
                            <option value="all">All Shifts</option>
                            <option value="Day Shift">Day Shift</option>
                            <option value="Night Shift">Night Shift</option>
                        </select>
                        <select id="filter-past-turnover-team" class="compact-filter-select">
                            <option value="all">All Teams</option>
                            <option value="A">Team A</option>
                            <option value="B">Team B</option>
                            <option value="C">Team C</option>
                            <option value="D">Team D</option>
                        </select>
                        <button id="applyPastTurnoverFilter" class="compact-export-btn bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-transform transform hover:scale-105">
                            Apply Filter
                        </button>
                        <button id="clearPastTurnoverFilter" class="compact-export-btn bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition-transform transform hover:scale-105">
                            Clear Filter
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Shift</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Team</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">In Progress Tickets</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolved Tickets</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Scheduled Events</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">General Info</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Reminders</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">On-call Updates</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="past-turnover-table" class="divide-y divide-gray-200">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for Past Turnover -->
                    <div id="past-turnover-pagination" class="pagination mt-4 hidden">
                        <!-- Pagination buttons will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Reports -->
            <div id="reports-content" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Reports</h2>
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button id="generateDailyReportBtn" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Generate Daily Report</button>
                        <button id="generateWeeklyReportBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Generate Weekly Report</button>
                        <button id="generateMonthlyReportBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Generate Monthly Report</button>
                        <button id="takeScreenshotBtn" class="screenshot-btn font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 hidden">Take Screenshot</button>
                        <button id="downloadReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 hidden">Download Report (Excel)</button>
                    </div>
                    
                    <!-- Report Period Display -->
                    <div id="report-period-display" class="report-period hidden">
                        <!-- Period information will be displayed here -->
                    </div>
                    
                    <!-- Report content for screenshot -->
                    <div id="report-screenshot-content">
                        <div id="report-output" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                           <!-- Report charts and stats will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Online Users Panel -->
    <div id="onlineUsersPanel" class="online-users hidden">
        <div class="online-users-header">Online Users</div>
        <div id="onlineUsersList"></div>
    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                 <h3 class="text-lg leading-6 font-medium modal-header" id="modalTitle">New Ticket</h3>
                 <form id="ticketForm" class="mt-2 space-y-4 text-left p-4">
                    <input type="hidden" id="ticketId">
                    <input type="hidden" id="ticketVersion" value="0">
                    <div>
                        <label for="ticketDate" class="enhanced-label">Date</label>
                        <input type="date" id="ticketDate" name="ticketDate" required class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-input">
                    </div>
                    <div>
                        <label for="shift" class="enhanced-label">Shift</label>
                        <select id="shift" name="shift" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Shift</option>
                            <option>Day</option>
                            <option>Night</option>
                        </select>
                    </div>
                    <div>
                        <label for="handledBy" class="enhanced-label">Handled By</label>
                        <select id="handledBy" name="handledBy" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Assignee</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label for="ticketNumber" class="enhanced-label">Ticket Number</label>
                        <input type="text" id="ticketNumber" name="ticketNumber" required class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-input">
                    </div>
                    <div>
                        <label for="priority" class="enhanced-label">Priority</label>
                        <select id="priority" name="priority" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Priority</option>
                            <option>P1</option>
                            <option>P2</option>
                            <option>P3</option>
                            <option>P4</option>
                        </select>
                    </div>
                    <!-- NEW: Environment Field -->
                    <div>
                        <label for="environment" class="enhanced-label">Environment</label>
                        <select id="environment" name="environment" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Environment</option>
                            <option>Prod</option>
                            <option>UAT</option>
                            <option>N/A</option>
                        </select>
                    </div>
                    <div>
                        <label for="issueType" class="enhanced-label">Issue/Request</label>
                        <select id="issueType" name="issueType" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Issue Type</option>
                            <option value="Zena Failed Jobs - BPI">Zena Failed Jobs - BPI</option>
                            <option value="Zena Failed Jobs - DB">Zena Failed Jobs - DB</option>
                            <option value="Netcool Alert">Netcool Alert</option>
                            <option value="PagerDuty Alert">PagerDuty Alert</option>
                            <option value="PowerBroker (SDDC)">PowerBroker (SDDC)</option>
                            <option value="PowerBroker (Cloud AWS)">PowerBroker (Cloud AWS)</option>
                            <option value="CSOC - Phishing Email">CSOC - Phishing Email</option>
                            <option value="Service Request - Data Center Access">Service Request - Data Center Access</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="enhanced-label">Description</label>
                        <textarea id="description" name="description" rows="3" required class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-textarea"></textarea>
                    </div>
                    <div>
                        <label for="resolution" class="enhanced-label">Resolution</label>
                        <textarea id="resolution" name="resolution" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-textarea"></textarea>
                    </div>
                    <div>
                        <label for="status" class="enhanced-label">Status</label>
                        <select id="status" name="status" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Status</option>
                            <option>In Progress</option>
                            <option>Resolved</option>
                        </select>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="saveTicketBtn" type="submit" class="px-4 py-2 text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 modal-save-btn">Save</button>
                        <button id="cancelModalBtn" type="button" class="mt-2 px-4 py-2 text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300 modal-cancel-btn">Cancel</button>
                        <button id="deleteTicketBtn" type="button" class="mt-4 px-4 py-2 text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-red-300 modal-delete-btn hidden">Delete Ticket</button>
                    </div>
                 </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Conflict Modal -->
    <div id="editConflictModal" class="edit-conflict-modal hidden">
        <div class="edit-conflict-content">
            <h3 class="text-lg font-bold mb-4">Edit Conflict</h3>
            <p class="mb-4">This ticket has been modified by another user since you started editing. How would you like to proceed?</p>
            <div class="flex gap-4">
                <button id="overwriteChangesBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Overwrite Their Changes</button>
                <button id="reloadTicketBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md">Reload Their Version</button>
                <button id="cancelEditBtn" class="px-4 py-2 bg-red-600 text-white rounded-md">Cancel Edit</button>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-5 right-5 z-[100]"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, serverTimestamp, query, orderBy, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYSpKkDqkOtw34ed51EoeFMbuhvcJmHkc",
            authDomain: "ops-manila.firebaseapp.com",
            projectId: "ops-manila",
            storageBucket: "ops-manila.firebasestorage.app",
            messagingSenderId: "362005177325",
            appId: "1:362005177325:web:130e47f47992089ce03de4",
            measurementId: "G-W3VQBSBWY5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Global State
        const assigneesList = ['Geron', 'John Mick', 'Nelson', 'Anna', 'Judy', 'Joyce', 'Ceriaco', 'Jonnie', 'Danica', 'Jake', 'Joseph', 'Jeremiah'];
        const appId = 'ticket-tracker-app'; // Fixed app ID for collection path
        let allTickets = [];
        let reportData = null; // To store generated report data for download
        let currentReportType = null; // Track current report type
        
        // Pagination state
        const itemsPerPage = 15;
        let currentPageInProgress = 1;
        let currentPageResolved = 1;
        let currentPagePastTurnover = 1;
        
        // Real-time collaboration state
        let currentUser = null;
        let onlineUsers = {};
        let userSessionId = null;
        let editingTicketId = null;
        let editingTicketVersion = 0;

        // Turnover state 
        let turnoverData = {
            date: new Date().toISOString().split('T')[0],
            shift: '',
            team: '', // No default team
            scheduledEvents: [],
            generalInfo: [],
            reminders: [],
            onCallUpdates: []
        };

        // NEW: User selection state
        let selectedUserName = null;
        const availableUsers = ['Geron', 'John Mick', 'Nelson', 'Joseph', 'Danica', 'Jeremiah', 'Judy', 'Anna', 'Joyce', 'Jake', 'Jonnie', 'Ceriaco'];

        // NEW: Past Turnovers state
        let pastTurnovers = [];

        // DOM Elements
        const addTicketBtn = document.getElementById('addTicketBtn');
        const modal = document.getElementById('ticketModal');
        const modalTitle = document.getElementById('modalTitle');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const ticketForm = document.getElementById('ticketForm');
        const saveTicketBtn = document.getElementById('saveTicketBtn');
        const deleteTicketBtn = document.getElementById('deleteTicketBtn');
        const reportPeriodDisplay = document.getElementById('report-period-display');
        const takeScreenshotBtn = document.getElementById('takeScreenshotBtn');
        const onlineUsersPanel = document.getElementById('onlineUsersPanel');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserStatus = document.getElementById('currentUserStatus');
        const realTimeIndicator = document.getElementById('realTimeIndicator');
        const updateMessage = document.getElementById('updateMessage');
        const editConflictModal = document.getElementById('editConflictModal');
        const overwriteChangesBtn = document.getElementById('overwriteChangesBtn');
        const reloadTicketBtn = document.getElementById('reloadTicketBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const generateDailyReportBtn = document.getElementById('generateDailyReportBtn');
        const generateWeeklyReportBtn = document.getElementById('generateWeeklyReportBtn');
        const generateMonthlyReportBtn = document.getElementById('generateMonthlyReportBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const takeTurnoverScreenshotBtn = document.getElementById('takeTurnoverScreenshotBtn');
        
        // UPDATED: Export dropdowns and buttons
        const exportInProgressPeriod = document.getElementById('exportInProgressPeriod');
        const exportInProgressBtn = document.getElementById('exportInProgressBtn');
        const exportResolvedPeriod = document.getElementById('exportResolvedPeriod');
        const exportResolvedBtn = document.getElementById('exportResolvedBtn');
        
        // NEW: Turnover DOM Elements
        const turnoverDateInput = document.getElementById('turnover-date');
        const turnoverShiftSelect = document.getElementById('turnover-shift');
        const turnoverTeamSelect = document.getElementById('turnover-team'); // NEW
        const turnoverInProgressCount = document.getElementById('turnover-in-progress-count');
        const turnoverResolvedCount = document.getElementById('turnover-resolved-count');
        const turnoverScheduledEvents = document.getElementById('turnover-scheduled-events');
        const turnoverGeneralInfo = document.getElementById('turnover-general-info');
        const turnoverReminders = document.getElementById('turnover-reminders');
        const turnoverOncallUpdates = document.getElementById('turnover-oncall-updates');
        const newScheduledEventInput = document.getElementById('new-scheduled-event');
        const addScheduledEventBtn = document.getElementById('add-scheduled-event');
        const newGeneralInfoInput = document.getElementById('new-general-info');
        const addGeneralInfoBtn = document.getElementById('add-general-info');
        const newReminderInput = document.getElementById('new-reminder');
        const addReminderBtn = document.getElementById('add-reminder');
        const newOncallUpdateInput = document.getElementById('new-oncall-update');
        const addOncallUpdateBtn = document.getElementById('add-oncall-update');
        
        // NEW: User Selection Modal Elements
        const userSelectionModal = document.getElementById('userSelectionModal');
        const userOptionsGrid = document.getElementById('userOptionsGrid');
        const confirmUserBtn = document.getElementById('confirmUserBtn');
        
        // NEW: Save Turnover Button
        const saveTurnoverBtn = document.getElementById('saveTurnoverBtn');
        
        // NEW: Past Turnover DOM Elements
        const pastTurnoverTable = document.getElementById('past-turnover-table');
        const filterPastTurnoverDate = document.getElementById('filter-past-turnover-date');
        const filterPastTurnoverShift = document.getElementById('filter-past-turnover-shift');
        const filterPastTurnoverTeam = document.getElementById('filter-past-turnover-team'); // NEW
        const applyPastTurnoverFilter = document.getElementById('applyPastTurnoverFilter');
        const clearPastTurnoverFilter = document.getElementById('clearPastTurnoverFilter');
        
        // NEW: Clear Filter Buttons
        const clearInProgressFilterBtn = document.getElementById('clearInProgressFilter');
        const clearResolvedFilterBtn = document.getElementById('clearResolvedFilter');
        
        // --- MAIN APP INITIALIZATION ---
        function initApp() {
            // Check if user is already selected
            const storedUser = localStorage.getItem('ticketTrackerUserName');
            if (storedUser) {
                // User already selected, proceed with app initialization
                initializeUserSession(storedUser);
                setupRealtimeListeners();
                setupEventListeners();
                populateStaticAssigneeDropdowns();
                switchTab('in-progress');
                setupOnlineUsersPanel();
                initializeTurnover();
                setupPastTurnover();
            } else {
                // Show user selection modal
                showUserSelectionModal();
            }
        }
        
        // --- USER SELECTION FUNCTIONALITY ---
        function showUserSelectionModal() {
            // Shuffle the user list for random order
            const shuffledUsers = [...availableUsers].sort(() => Math.random() - 0.5);
            
            // Clear previous options
            userOptionsGrid.innerHTML = '';
            
            // Create user option elements
            shuffledUsers.forEach(user => {
                const userOption = document.createElement('div');
                userOption.className = 'user-option';
                userOption.dataset.username = user;
                
                const avatar = document.createElement('div');
                avatar.className = 'user-option-avatar';
                avatar.style.backgroundColor = generateUserColor(user);
                avatar.textContent = user.charAt(0);
                
                const name = document.createElement('div');
                name.className = 'user-option-name';
                name.textContent = user;
                
                userOption.appendChild(avatar);
                userOption.appendChild(name);
                
                userOption.addEventListener('click', () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.user-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    userOption.classList.add('selected');
                    selectedUserName = user;
                });
                
                userOptionsGrid.appendChild(userOption);
            });
            
            // Show the modal
            userSelectionModal.classList.remove('hidden');
        }
        
        function confirmUserSelection() {
            if (!selectedUserName) {
                alert('Please select a username to continue.');
                return;
            }
            
            // Store the selected user
            localStorage.setItem('ticketTrackerUserName', selectedUserName);
            
            // Hide the modal
            userSelectionModal.classList.add('hidden');
            
            // Initialize the app with the selected user
            initializeUserSession(selectedUserName);
            setupRealtimeListeners();
            setupEventListeners();
            populateStaticAssigneeDropdowns();
            switchTab('in-progress');
            setupOnlineUsersPanel();
            initializeTurnover();
            setupPastTurnover();
            
            showNotification(`Welcome, ${selectedUserName}!`, 'success');
        }
        
        // --- REAL-TIME COLLABORATION ---
        function initializeUserSession(userName) {
            // Generate a unique session ID for this user
            userSessionId = 'user-' + Math.random().toString(36).substring(2, 15);
            
            currentUser = {
                id: userSessionId,
                name: userName,
                lastSeen: serverTimestamp(),
                online: true
            };
            
            // Update UI with user info
            currentUserName.textContent = currentUser.name;
            currentUserAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            currentUserAvatar.style.backgroundColor = generateUserColor(currentUser.id);
            
            // Register user in the online users collection
            registerUserPresence();
        }
        
        function generateUserColor(userId) {
            // Generate a consistent color based on user ID
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 60%)`;
        }
        
        function registerUserPresence() {
            if (!currentUser) return;
            
            const userRef = doc(db, `/artifacts/${appId}/public/data/onlineUsers`, currentUser.id);
            
            // Set user as online
            setDoc(userRef, {
                ...currentUser,
                lastSeen: serverTimestamp(),
                online: true
            });
            
            // Set up cleanup on page unload
            window.addEventListener('beforeunload', () => {
                setDoc(userRef, {
                    ...currentUser,
                    lastSeen: serverTimestamp(),
                    online: false
                }, { merge: true });
            });
        }
        
        function setupRealtimeListeners() {
            // Tickets collection listener
            const ticketsCollectionRef = collection(db, `/artifacts/${appId}/public/data/tickets`);
            const q = query(ticketsCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const previousTicketCount = allTickets.length;
                allTickets = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // Add version for optimistic concurrency control
                    _version: doc.data()._version || 0
                }));
                
                // Show real-time update indicator if this isn't the initial load
                if (previousTicketCount > 0) {
                    showRealTimeUpdate();
                }
                
                renderTickets();
                
                // NEW: Update turnover tickets if turnover tab is active
                if (!document.getElementById('turnover-content').classList.contains('hidden')) {
                    updateTurnoverTickets();
                }
                
                // Auto-refresh report if reports tab is active and a report type is selected
                if (!document.getElementById('reports-content').classList.contains('hidden') && currentReportType) {
                    generateReport(currentReportType);
                }
            }, (error) => {
                console.error("Error fetching tickets: ", error);
                showNotification('Error fetching tickets.', 'error');
            });

            // Online users collection listener
            const onlineUsersRef = collection(db, `/artifacts/${appId}/public/data/onlineUsers`);
            onSnapshot(onlineUsersRef, (snapshot) => {
                onlineUsers = {};
                snapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    // Only include users seen in the last 2 minutes
                    if (userData.lastSeen) {
                        const lastSeen = userData.lastSeen.toDate();
                        const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000);
                        if (lastSeen > twoMinutesAgo && userData.online !== false) {
                            onlineUsers[doc.id] = userData;
                        }
                    }
                });
                
                updateOnlineUsersDisplay();
            });
            
            // NEW: Turnover data listener
            const turnoverRef = doc(db, `/artifacts/${appId}/public/data/turnover`, 'current');
            onSnapshot(turnoverRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    turnoverData = {
                        ...turnoverData,
                        ...data
                    };
                    renderTurnoverData();
                }
            });
        }
        
        function showRealTimeUpdate() {
            updateMessage.textContent = 'Ticket data updated in real-time';
            realTimeIndicator.style.display = 'block';
            
            setTimeout(() => {
                realTimeIndicator.style.display = 'none';
            }, 3000);
        }
        
        function updateOnlineUsersDisplay() {
            const currentUserCount = Object.keys(onlineUsers).length;
            
            // Update user count in header
            document.querySelectorAll('.user-count').forEach(el => el.remove());
            
            const userCountBadge = document.createElement('span');
            userCountBadge.className = 'user-count bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full ml-2';
            userCountBadge.textContent = `${currentUserCount} online`;
            currentUserName.parentNode.appendChild(userCountBadge);
            
            // Update online users panel
            onlineUsersList.innerHTML = '';
            
            Object.values(onlineUsers).forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'online-user';
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.backgroundColor = generateUserColor(user.id);
                avatar.textContent = user.name.charAt(0).toUpperCase();
                
                const name = document.createElement('span');
                name.className = 'text-sm';
                name.textContent = user.name;
                
                const status = document.createElement('div');
                status.className = 'user-status';
                
                userEl.appendChild(avatar);
                userEl.appendChild(name);
                userEl.appendChild(status);
                onlineUsersList.appendChild(userEl);
            });
        }
        
        function setupOnlineUsersPanel() {
            let hideTimeout;
            
            currentUserName.parentNode.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
                onlineUsersPanel.classList.remove('hidden');
            });
            
            currentUserName.parentNode.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    onlineUsersPanel.classList.add('hidden');
                }, 500);
            });
            
            onlineUsersPanel.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
            });
            
            onlineUsersPanel.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    onlineUsersPanel.classList.add('hidden');
                }, 500);
            });
        }
        
        // --- OPTIMISTIC CONCURRENCY CONTROL ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const ticketId = document.getElementById('ticketId').value;
            const formData = new FormData(ticketForm);
            const ticketData = Object.fromEntries(formData.entries());
            const currentVersion = parseInt(document.getElementById('ticketVersion').value);

            // NEW: Validate that description and resolution are not empty when resolving
            if (ticketData.status === 'Resolved') {
                if (!ticketData.description || ticketData.description.trim() === '') {
                    showNotification('Description cannot be empty when resolving a ticket.', 'error');
                    return;
                }
                if (!ticketData.resolution || ticketData.resolution.trim() === '') {
                    showNotification('Resolution cannot be empty when resolving a ticket.', 'error');
                    return;
                }
            }

            // Check for edit conflicts
            if (ticketId) {
                const existingTicket = allTickets.find(t => t.id === ticketId);
                if (existingTicket && existingTicket._version > currentVersion) {
                    // Show conflict resolution modal
                    showEditConflictModal(ticketId, ticketData, existingTicket);
                    return;
                }
            }

            // If no conflict, proceed with save
            await saveTicketData(ticketId, ticketData, currentVersion);
        }
        
        function showEditConflictModal(ticketId, localData, serverData) {
            editingTicketId = ticketId;
            editConflictModal.classList.remove('hidden');
            
            // Set up conflict resolution buttons
            overwriteChangesBtn.onclick = () => {
                // Overwrite server changes with local changes
                saveTicketData(ticketId, localData, serverData._version);
                editConflictModal.classList.add('hidden');
            };
            
            reloadTicketBtn.onclick = () => {
                // Reload the server version into the form
                openModal(serverData);
                editConflictModal.classList.add('hidden');
            };
            
            cancelEditBtn.onclick = () => {
                // Just close the modal and form
                editConflictModal.classList.add('hidden');
                closeModal();
            };
        }
        
        async function saveTicketData(ticketId, ticketData, currentVersion) {
            // Add timestamps and version
            const isResolved = ticketData.status === 'Resolved';
            const wasPreviouslyResolved = ticketId ? allTickets.find(t => t.id === ticketId)?.status === 'Resolved' : false;

            ticketData.updatedAt = serverTimestamp();
            ticketData._version = (currentVersion || 0) + 1;
            
            if (isResolved && !wasPreviouslyResolved) {
                ticketData.resolvedAt = serverTimestamp();
            }

            try {
                if (ticketId) {
                    // Update existing ticket
                    const docRef = doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId);
                    await setDoc(docRef, ticketData, { merge: true });
                    showNotification('Ticket updated successfully!', 'success');
                } else {
                    // Create new ticket
                    ticketData.createdAt = serverTimestamp();
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/tickets`), ticketData);
                    showNotification('Ticket created successfully!', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving ticket: ", error);
                showNotification('Error saving ticket: ' + error.message, 'error');
            }
        }

        // --- UI RENDERING ---
        function renderTickets() {
            const inProgressTable = document.getElementById('in-progress-tickets-table');
            const resolvedTable = document.getElementById('resolved-tickets-table');
            
            // Display ALL tickets in both tabs by default
            let inProgressTickets = allTickets.filter(t => t.status !== 'Resolved');
            let resolvedTickets = allTickets.filter(t => t.status === 'Resolved');
            
            // Apply sorting (but don't filter by default)
            inProgressTickets = sortTickets(inProgressTickets, 'in-progress');
            resolvedTickets = sortTickets(resolvedTickets, 'resolved');
            
            // Apply pagination
            const inProgressTotalPages = Math.ceil(inProgressTickets.length / itemsPerPage);
            const resolvedTotalPages = Math.ceil(resolvedTickets.length / itemsPerPage);
            
            // Ensure current page is valid
            currentPageInProgress = Math.min(currentPageInProgress, Math.max(1, inProgressTotalPages));
            currentPageResolved = Math.min(currentPageResolved, Math.max(1, resolvedTotalPages));
            
            // Get current page items
            const inProgressStartIndex = (currentPageInProgress - 1) * itemsPerPage;
            const inProgressEndIndex = inProgressStartIndex + itemsPerPage;
            const inProgressPageItems = inProgressTickets.slice(inProgressStartIndex, inProgressEndIndex);
            
            const resolvedStartIndex = (currentPageResolved - 1) * itemsPerPage;
            const resolvedEndIndex = resolvedStartIndex + itemsPerPage;
            const resolvedPageItems = resolvedTickets.slice(resolvedStartIndex, resolvedEndIndex);
            
            // Render tables
            inProgressTable.innerHTML = inProgressPageItems.map(ticket => createInProgressRow(ticket)).join('');
            resolvedTable.innerHTML = resolvedPageItems.map(ticket => createResolvedRow(ticket)).join('');
            
            // Render pagination
            renderPagination('in-progress', inProgressTickets.length, currentPageInProgress, inProgressTotalPages);
            renderPagination('resolved', resolvedTickets.length, currentPageResolved, resolvedTotalPages);
            
            // Event listeners for dropdowns - using event delegation instead
            setupDropdownEventListeners();
        }
        
        function renderPagination(type, totalItems, currentPage, totalPages) {
            const paginationContainer = document.getElementById(`${type}-pagination`);
            
            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }
            
            paginationContainer.classList.remove('hidden');
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Previous</button>`;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust if we're at the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" data-page="1">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
            }
            
            // Next button
            paginationHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Next</button>`;
            
            // Info
            paginationHTML += `<span class="pagination-info">Showing ${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)}-${Math.min(currentPage * itemsPerPage, totalItems)} of ${totalItems}</span>`;
            
            paginationContainer.innerHTML = paginationHTML;
            
            // Add event listeners to pagination buttons
            paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!e.target.disabled) {
                        const page = parseInt(e.target.dataset.page);
                        if (type === 'in-progress') {
                            currentPageInProgress = page;
                        } else {
                            currentPageResolved = page;
                        }
                        renderTickets();
                    }
                });
            });
        }

        function createInProgressRow(ticket) {
            const age = ticket.createdAt ? formatDistanceToNow(ticket.createdAt.toDate()) : 'N/A';
            const status = ticket.status === 'Resolved' ? 'Resolved' : 'In Progress'; // Normalize status
            const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toLocaleDateString() : (ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A');
            
            // Truncate long text
            const shortIssueType = ticket.issueType ? (ticket.issueType.length > 30 ? ticket.issueType.substring(0, 30) + '...' : ticket.issueType) : '-';
            const shortDescription = ticket.description ? (ticket.description.length > 50 ? ticket.description.substring(0, 50) + '...' : ticket.description) : '-';
            const shortResolution = ticket.resolution ? (ticket.resolution.length > 50 ? ticket.resolution.substring(0, 50) + '...' : ticket.resolution) : '-';
            
            return `
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="py-3 px-4 text-xs text-gray-500">${ticketDate}</td>
                    <td class="py-3 px-4">${ticket.shift}</td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.handledBy}">${ticket.handledBy}</td>
                    <td class="py-3 px-4 font-mono truncate-cell" title="${ticket.ticketNumber}">${ticket.ticketNumber}</td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full priority-${ticket.priority}">${ticket.priority}</span></td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full environment-${ticket.environment || 'N/A'}">${ticket.environment || 'N/A'}</span></td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(status)}">${status}</span></td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.issueType || 'Not specified'}">${shortIssueType}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.description || 'No description'}">${shortDescription}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.resolution || 'No resolution yet'}">${shortResolution}</td>
                    <td class="py-3 px-4 text-xs text-gray-500">${age}</td>
                    <td class="py-3 px-4 relative">
                        <div class="dropdown-container relative inline-block">
                            <button class="ellipsis-btn text-gray-600 hover:text-blue-600 text-lg font-bold" data-id="${ticket.id}"></button>
                            <div class="dropdown-menu">
                                <button class="dropdown-item edit" data-id="${ticket.id}">Edit</button>
                                <button class="dropdown-item resolve" data-id="${ticket.id}">Mark as Resolved</button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function createResolvedRow(ticket) {
            const resolvedDate = ticket.resolvedAt ? ticket.resolvedAt.toDate().toLocaleDateString() : 'N/A';
            const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toLocaleDateString() : (ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A');
            
            // Truncate long text
            const shortIssueType = ticket.issueType ? (ticket.issueType.length > 30 ? ticket.issueType.substring(0, 30) + '...' : ticket.issueType) : '-';
            const shortDescription = ticket.description ? (ticket.description.length > 50 ? ticket.description.substring(0, 50) + '...' : ticket.description) : '-';
            const shortResolution = ticket.resolution ? (ticket.resolution.length > 50 ? ticket.resolution.substring(0, 50) + '...' : ticket.resolution) : '-';
            
            return `
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="py-3 px-4 text-xs text-gray-500">${ticketDate}</td>
                    <td class="py-3 px-4">${ticket.shift}</td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.handledBy}">${ticket.handledBy}</td>
                    <td class="py-3 px-4 font-mono truncate-cell" title="${ticket.ticketNumber}">${ticket.ticketNumber}</td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full priority-${ticket.priority}">${ticket.priority}</span></td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full environment-${ticket.environment || 'N/A'}">${ticket.environment || 'N/A'}</span></td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.issueType || 'Not specified'}">${shortIssueType}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.description || 'No description'}">${shortDescription}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.resolution || 'No resolution'}">${shortResolution}</td>
                    <td class="py-3 px-4 text-xs text-gray-500">${resolvedDate}</td>
                    <td class="py-3 px-4 relative">
                        <div class="dropdown-container relative inline-block">
                            <button class="ellipsis-btn text-gray-600 hover:text-blue-600 text-lg font-bold" data-id="${ticket.id}"></button>
                            <div class="dropdown-menu">
                                <button class="dropdown-item edit" data-id="${ticket.id}">View/Edit</button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Dropdown event listeners with event delegation
        function setupDropdownEventListeners() {
            // Close all dropdowns when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown-container')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });

            // Event delegation for ellipsis buttons
            document.addEventListener('click', function(e) {
                // Handle ellipsis button clicks
                if (e.target.classList.contains('ellipsis-btn')) {
                    e.stopPropagation();
                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        if (menu !== e.target.nextElementSibling) {
                            menu.classList.remove('show');
                        }
                    });
                    // Toggle current dropdown
                    const dropdown = e.target.nextElementSibling;
                    dropdown.classList.toggle('show');
                }
                
                // Handle dropdown item clicks for tickets
                if (e.target.classList.contains('dropdown-item')) {
                    e.stopPropagation();
                    const ticketId = e.target.dataset.id;
                    
                    if (e.target.classList.contains('edit')) {
                        const ticket = allTickets.find(t => t.id === ticketId);
                        if (ticket) {
                            openModal(ticket);
                        }
                    } else if (e.target.classList.contains('resolve')) {
                        markAsResolved(ticketId);
                    }
                    
                    // Close dropdown
                    e.target.closest('.dropdown-menu').classList.remove('show');
                }
                
                // Handle dropdown item clicks for past turnover
                if (e.target.classList.contains('view-past-turnover')) {
                    e.stopPropagation();
                    const turnoverId = e.target.dataset.id;
                    const turnover = pastTurnovers.find(t => t.id === turnoverId);
                    viewPastTurnoverDetails(turnover);
                    e.target.closest('.dropdown-menu').classList.remove('show');
                } else if (e.target.classList.contains('delete-past-turnover')) {
                    e.stopPropagation();
                    const turnoverId = e.target.dataset.id;
                    deletePastTurnover(turnoverId);
                    e.target.closest('.dropdown-menu').classList.remove('show');
                }
            });
        }

        async function markAsResolved(ticketId) {
            try {
                const ticket = allTickets.find(t => t.id === ticketId);
                
                // NEW: Validate that description and resolution are not empty
                if (!ticket.description || ticket.description.trim() === '') {
                    showNotification('Cannot resolve ticket: Description is empty.', 'error');
                    return;
                }
                if (!ticket.resolution || ticket.resolution.trim() === '') {
                    showNotification('Cannot resolve ticket: Resolution is empty.', 'error');
                    return;
                }
                
                const docRef = doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId);
                await setDoc(docRef, {
                    status: 'Resolved',
                    resolvedAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    _version: (ticket._version || 0) + 1
                }, { merge: true });
                showNotification('Ticket marked as resolved!', 'success');
            } catch (error) {
                console.error("Error resolving ticket: ", error);
                showNotification('Error resolving ticket.', 'error');
            }
        }

        function populateStaticAssigneeDropdowns() {
            const inProgressDropdown = document.getElementById('sort-in-progress-assignee');
            const resolvedDropdown = document.getElementById('sort-resolved-assignee');
            const handledByDropdown = document.getElementById('handledBy');

            // Shuffle the assignees list for random order
            const shuffledAssignees = [...assigneesList].sort(() => Math.random() - 0.5);
            const options = shuffledAssignees.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Add assignee options to sorting dropdowns
            inProgressDropdown.innerHTML = '<option value="default">All Assignees</option>' + options;
            resolvedDropdown.innerHTML = '<option value="default">All Assignees</option>' + options;
            
            // Populate handledBy dropdown in modal with blank default
            handledByDropdown.innerHTML = '<option value="" disabled selected>Select Assignee</option>' + options;
        }

        // --- MODAL & FORM HANDLING ---
        function openModal(ticket = null) {
            ticketForm.reset();
            deleteTicketBtn.classList.add('hidden');
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ticketDate').value = today;
            
            if (ticket) {
                modalTitle.textContent = 'Edit Ticket';
                document.getElementById('ticketId').value = ticket.id;
                document.getElementById('ticketDate').value = ticket.ticketDate || today;
                document.getElementById('shift').value = ticket.shift;
                document.getElementById('handledBy').value = ticket.handledBy;
                document.getElementById('ticketNumber').value = ticket.ticketNumber;
                document.getElementById('priority').value = ticket.priority || '';
                document.getElementById('environment').value = ticket.environment || '';
                document.getElementById('issueType').value = ticket.issueType || '';
                document.getElementById('description').value = ticket.description || '';
                document.getElementById('resolution').value = ticket.resolution || '';
                document.getElementById('status').value = ticket.status === 'Resolved' ? 'Resolved' : 'In Progress';
                document.getElementById('ticketVersion').value = ticket._version || 0;
                
                deleteTicketBtn.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'New Ticket';
                document.getElementById('ticketId').value = '';
                document.getElementById('ticketVersion').value = '0';
                // Clear all selections for new tickets
                document.getElementById('shift').value = '';
                document.getElementById('handledBy').value = '';
                document.getElementById('priority').value = '';
                document.getElementById('environment').value = '';
                document.getElementById('issueType').value = '';
                document.getElementById('status').value = '';
                // Date is already set to today above
                // Clear text areas
                document.getElementById('description').value = '';
                document.getElementById('resolution').value = '';
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            editingTicketId = null;
        }

        async function handleDeleteTicket() {
            const ticketId = document.getElementById('ticketId').value;
            if (ticketId) {
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId));
                    showNotification('Ticket deleted.', 'warning');
                    closeModal();
                } catch(error) {
                     console.error("Error deleting ticket: ", error);
                     showNotification('Error deleting ticket.', 'error');
                }
            }
        }
        
        // --- SORTING ---
        function sortTickets(tickets, type) {
            const dateSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-date' : 'sort-resolved-date').value;
            const shiftSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-shift' : 'sort-resolved-shift').value;
            const assigneeSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-assignee' : 'sort-resolved-assignee').value;
            const prioritySort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-priority' : 'sort-resolved-priority').value;
            const environmentSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-environment' : 'sort-resolved-environment').value;
            const issueSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-issue' : 'sort-resolved-issue').value;
            const specificDateFilter = document.getElementById(type === 'in-progress' ? 'filter-in-progress-specific-date' : 'filter-resolved-specific-date').value;
            
            let sorted = [...tickets];

            // Filter by specific date if selected
            if (specificDateFilter) {
                sorted = sorted.filter(t => {
                    const ticketDate = t.ticketDate ? new Date(t.ticketDate).toISOString().split('T')[0] : 
                                          (t.createdAt ? t.createdAt.toDate().toISOString().split('T')[0] : '');
                    return ticketDate === specificDateFilter;
                });
            }

            // Filter by shift (only if not default)
            if(shiftSort !== 'default') {
                sorted = sorted.filter(t => t.shift === shiftSort);
            }
            
            // Filter by assignee (only if not default)
            if(assigneeSort !== 'default') {
                sorted = sorted.filter(t => t.handledBy === assigneeSort);
            }
            
            // Filter by priority (only if not default)
            if(prioritySort !== 'default') {
                sorted = sorted.filter(t => t.priority === prioritySort);
            }
            
            // Filter by environment (only if not default)
            if(environmentSort !== 'default') {
                sorted = sorted.filter(t => t.environment === environmentSort);
            }
            
            // Filter by issue type (only if not default)
            if(issueSort !== 'default') {
                sorted = sorted.filter(t => t.issueType === issueSort);
            }
            
            // Sort by date (always apply date sorting)
            sorted.sort((a, b) => {
                // Use ticketDate if available, otherwise use createdAt
                const dateA = a.ticketDate ? new Date(a.ticketDate) : (a.createdAt?.toDate() || new Date(0));
                const dateB = b.ticketDate ? new Date(b.ticketDate) : (b.createdAt?.toDate() || new Date(0));
                return dateSort === 'newest' ? dateB - dateA : dateA - dateB;
            });
            
            return sorted;
        }

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
            
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            
            // NEW: Update turnover when switching to turnover tab
            if (tabName === 'turnover') {
                updateTurnoverTickets();
            }
            
            // NEW: Load past turnovers when switching to past turnover tab
            if (tabName === 'past-turnover') {
                renderPastTurnovers();
            }
            
            // Auto-generate daily report when switching to reports tab
            if (tabName === 'reports' && !currentReportType) {
                generateReport('daily');
            } else if (tabName === 'reports' && currentReportType) {
                // If already have a report type, refresh it
                generateReport(currentReportType);
            }
        }

        // --- NOTIFICATIONS ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-blue-500'; // info
            if (type === 'success') bgColor = 'bg-blue-600';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';

            toast.className = `toast text-white px-6 py-3 rounded-lg shadow-lg mb-2 ${bgColor}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // --- NEW: TURNOVER FUNCTIONALITY - UPDATED ---
        function initializeTurnover() {
            // Set default date to today
            turnoverDateInput.value = new Date().toISOString().split('T')[0];
            
            // Set up event listeners for turnover
            turnoverDateInput.addEventListener('change', updateTurnoverTickets);
            turnoverShiftSelect.addEventListener('change', updateTurnoverTickets);
            turnoverTeamSelect.addEventListener('change', updateTurnoverTickets); // NEW
            
            addScheduledEventBtn.addEventListener('click', addScheduledEvent);
            addGeneralInfoBtn.addEventListener('click', addGeneralInfo);
            addReminderBtn.addEventListener('click', addReminder);
            addOncallUpdateBtn.addEventListener('click', addOncallUpdate);
            
            // NEW: Clear filter buttons
            clearInProgressFilterBtn.addEventListener('click', clearInProgressFilters);
            clearResolvedFilterBtn.addEventListener('click', clearResolvedFilters);
            
            // UPDATED: Allow Shift+Enter for multiple lines, Enter to submit
            newScheduledEventInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addScheduledEvent();
                }
            });
            
            newGeneralInfoInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addGeneralInfo();
                }
            });
            
            newReminderInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addReminder();
                }
            });
            
            newOncallUpdateInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addOncallUpdate();
                }
            });
            
            takeTurnoverScreenshotBtn.addEventListener('click', takeTurnoverScreenshot);
            saveTurnoverBtn.addEventListener('click', saveCurrentTurnover);
        }
        
        function updateTurnoverTickets() {
            const selectedDate = turnoverDateInput.value;
            const selectedShift = turnoverShiftSelect.value;
            
            // Filter tickets by date and shift
            const inProgressTickets = allTickets.filter(ticket => {
                const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                  (ticket.createdAt ? ticket.createdAt.toDate().toISOString().split('T')[0] : '');
                return ticketDate === selectedDate && 
                       ticket.shift === selectedShift.replace(' Shift', '') && 
                       ticket.status !== 'Resolved';
            });
            
            const resolvedTickets = allTickets.filter(ticket => {
                const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                  (ticket.createdAt ? ticket.createdAt.toDate().toISOString().split('T')[0] : '');
                return ticketDate === selectedDate && 
                       ticket.shift === selectedShift.replace(' Shift', '') && 
                       ticket.status === 'Resolved';
            });
            
            // Update the display with counts only
            turnoverInProgressCount.innerHTML = `
                <div class="text-3xl font-bold tickets-in-progress-count">${inProgressTickets.length}</div>
                <div class="text-sm tickets-in-progress-label">Tickets</div>
            `;
            
            turnoverResolvedCount.innerHTML = `
                <div class="text-3xl font-bold tickets-resolved-count">${resolvedTickets.length}</div>
                <div class="text-sm tickets-resolved-label">Tickets</div>
            `;
        }
        
        function renderTurnoverData() {
            // Render scheduled events
            turnoverScheduledEvents.innerHTML = turnoverData.scheduledEvents.length > 0 ? 
                turnoverData.scheduledEvents.map((event, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${event}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="scheduledEvents" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="scheduledEvents" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No scheduled events</div>';
                
            // Render general information
            turnoverGeneralInfo.innerHTML = turnoverData.generalInfo.length > 0 ? 
                turnoverData.generalInfo.map((info, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${info}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="generalInfo" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="generalInfo" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No general information</div>';
                
            // Render reminders
            turnoverReminders.innerHTML = turnoverData.reminders.length > 0 ? 
                turnoverData.reminders.map((reminder, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${reminder}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="reminders" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="reminders" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No reminders</div>';
                
            // Render on-call updates
            turnoverOncallUpdates.innerHTML = turnoverData.onCallUpdates.length > 0 ? 
                turnoverData.onCallUpdates.map((update, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${update}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="onCallUpdates" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="onCallUpdates" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No on-call updates</div>';
                
            // Attach event listeners to the new buttons
            attachTurnoverItemEventListeners();
        }
        
        function attachTurnoverItemEventListeners() {
            // Edit buttons
            document.querySelectorAll('.edit-turnover-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    const index = parseInt(e.target.dataset.index);
                    editTurnoverItem(section, index);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('.delete-turnover-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    const index = parseInt(e.target.dataset.index);
                    deleteTurnoverItem(section, index);
                });
            });
        }
        
        async function addScheduledEvent() {
            const event = newScheduledEventInput.value.trim();
            if (event) {
                turnoverData.scheduledEvents.push(event);
                await saveTurnoverData();
                newScheduledEventInput.value = '';
                showNotification('Scheduled event added', 'success');
            }
        }
        
        async function addGeneralInfo() {
            const info = newGeneralInfoInput.value.trim();
            if (info) {
                turnoverData.generalInfo.push(info);
                await saveTurnoverData();
                newGeneralInfoInput.value = '';
                showNotification('General information added', 'success');
            }
        }
        
        async function addReminder() {
            const reminder = newReminderInput.value.trim();
            if (reminder) {
                turnoverData.reminders.push(reminder);
                await saveTurnoverData();
                newReminderInput.value = '';
                showNotification('Reminder added', 'success');
            }
        }
        
        async function addOncallUpdate() {
            const update = newOncallUpdateInput.value.trim();
            if (update) {
                turnoverData.onCallUpdates.push(update);
                await saveTurnoverData();
                newOncallUpdateInput.value = '';
                showNotification('On-call update added', 'success');
            }
        }
        
        function editTurnoverItem(section, index) {
            const currentValue = turnoverData[section][index];
            const newValue = prompt(`Edit ${section.replace(/([A-Z])/g, ' $1').toLowerCase()}:`, currentValue);
            
            if (newValue !== null && newValue.trim() !== '') {
                turnoverData[section][index] = newValue.trim();
                saveTurnoverData();
                showNotification('Item updated', 'success');
            }
        }
        
        async function deleteTurnoverItem(section, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                turnoverData[section].splice(index, 1);
                await saveTurnoverData();
                showNotification('Item deleted', 'warning');
            }
        }
        
        async function saveTurnoverData() {
            try {
                const turnoverRef = doc(db, `/artifacts/${appId}/public/data/turnover`, 'current');
                await setDoc(turnoverRef, turnoverData);
            } catch (error) {
                console.error("Error saving turnover data: ", error);
                showNotification('Error saving turnover data.', 'error');
            }
        }
        
        // NEW: Save Current Turnover to Past Turnovers
        async function saveCurrentTurnover() {
            try {
                // Get current turnover data
                const selectedDate = turnoverDateInput.value;
                const selectedShift = turnoverShiftSelect.value;
                const selectedTeam = turnoverTeamSelect.value; // NEW
                
                // Validate required fields
                if (!selectedDate || !selectedShift || !selectedTeam) {
                    showNotification('Please fill in Date, Shift, and Team before saving turnover.', 'error');
                    return;
                }
                
                // Calculate ticket counts
                const inProgressTickets = allTickets.filter(ticket => {
                    const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                      (ticket.createdAt ? ticket.createdAt.toDate().toISOString().split('T')[0] : '');
                    return ticketDate === selectedDate && 
                           ticket.shift === selectedShift.replace(' Shift', '') && 
                           ticket.status !== 'Resolved';
                });
                
                const resolvedTickets = allTickets.filter(ticket => {
                    const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                      (ticket.createdAt ? ticket.createdAt.toDate().toISOString().split('T')[0] : '');
                    return ticketDate === selectedDate && 
                           ticket.shift === selectedShift.replace(' Shift', '') && 
                           ticket.status === 'Resolved';
                });
                
                // Create turnover object
                const turnoverToSave = {
                    date: selectedDate,
                    shift: selectedShift,
                    team: selectedTeam, // NEW
                    inProgressCount: inProgressTickets.length,
                    resolvedCount: resolvedTickets.length,
                    scheduledEvents: [...turnoverData.scheduledEvents],
                    generalInfo: [...turnoverData.generalInfo],
                    reminders: [...turnoverData.reminders],
                    onCallUpdates: [...turnoverData.onCallUpdates],
                    savedBy: currentUser.name,
                    savedAt: serverTimestamp()
                };
                
                // Save to Firestore
                await addDoc(collection(db, `/artifacts/${appId}/public/data/pastTurnovers`), turnoverToSave);
                
                showNotification('Turnover saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving turnover: ", error);
                showNotification('Error saving turnover.', 'error');
            }
        }
        
        // Turnover screenshot to include date, shift, and team
        async function takeTurnoverScreenshot() {
            try {
                showNotification('Taking turnover screenshot...', 'info');
                
                // Add screenshot mode class to hide edit/delete buttons
                document.getElementById('turnover-content').classList.add('screenshot-mode');
                
                // Small delay to ensure CSS is applied
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Create a temporary container for the screenshot that includes date, shift and team info
                const tempContainer = document.createElement('div');
                tempContainer.style.padding = '20px';
                tempContainer.style.backgroundColor = '#ffffff';
                
                // Add header with date, shift and team information
                const headerSection = document.createElement('div');
                headerSection.style.marginBottom = '20px';
                headerSection.style.padding = '15px';
                headerSection.style.backgroundColor = '#1e3a8a';
                headerSection.style.color = 'white';
                headerSection.style.borderRadius = '8px';
                headerSection.style.textAlign = 'center';
                
                // Get current selected values for the screenshot
                const date = document.getElementById('turnover-date').value;
                const shift = document.getElementById('turnover-shift').value;
                const team = document.getElementById('turnover-team').value;
                
                headerSection.innerHTML = `
                    <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: bold;">Turnover Report</h2>
                    <div style="display: flex; justify-content: center; gap: 30px; font-size: 16px;">
                        <div><strong>Date:</strong> ${date || 'Not selected'}</div>
                        <div><strong>Shift:</strong> ${shift || 'Not selected'}</div>
                        <div><strong>Team:</strong> ${team ? 'Team ' + team : 'Not selected'}</div>
                    </div>
                `;
                
                // Clone the turnover content
                const turnoverContent = document.getElementById('turnover-content');
                const turnoverClone = turnoverContent.cloneNode(true);
                
                // Remove the screenshot button and save button from the clone
                const screenshotBtn = turnoverClone.querySelector('#takeTurnoverScreenshotBtn');
                if (screenshotBtn) screenshotBtn.remove();
                const saveBtn = turnoverClone.querySelector('#saveTurnoverBtn');
                if (saveBtn) saveBtn.remove();
                
                // Append header and content to temp container
                tempContainer.appendChild(headerSection);
                tempContainer.appendChild(turnoverClone);
                
                // Add temp container to body (off-screen)
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                document.body.appendChild(tempContainer);
                
                // Use html2canvas to capture the temp container
                const canvas = await html2canvas(tempContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });
                
                // Remove temp container
                document.body.removeChild(tempContainer);
                
                // Convert canvas to image and download
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                const formattedDate = date || new Date().toISOString().split('T')[0];
                const formattedShift = shift ? shift.replace(' ', '_') : 'Not_Selected';
                const formattedTeam = team ? `_Team_${team}` : '_Team_Not_Selected';
                link.download = `Turnover_${formattedDate}_${formattedShift}${formattedTeam}.png`;
                link.href = image;
                link.click();
                
                showNotification('Turnover screenshot downloaded!', 'success');
            } catch (error) {
                console.error('Error taking turnover screenshot:', error);
                showNotification('Error taking turnover screenshot.', 'error');
            } finally {
                // Remove screenshot mode class to show edit/delete buttons again
                document.getElementById('turnover-content').classList.remove('screenshot-mode');
                
                // Clean up any remaining temp containers
                const tempContainers = document.querySelectorAll('[style*="left: -9999px"]');
                tempContainers.forEach(container => container.remove());
            }
        }

        // --- NEW: PAST TURNOVER FUNCTIONALITY - UPDATED WITH TEAM ---
        function setupPastTurnover() {
            // Set up real-time listener for past turnovers
            const pastTurnoversRef = collection(db, `/artifacts/${appId}/public/data/pastTurnovers`);
            const q = query(pastTurnoversRef, orderBy('savedAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                pastTurnovers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderPastTurnovers();
            });
        }
        
        function renderPastTurnovers() {
            let filteredTurnovers = [...pastTurnovers];
            
            // Apply filters
            const dateFilter = filterPastTurnoverDate.value;
            const shiftFilter = filterPastTurnoverShift.value;
            const teamFilter = filterPastTurnoverTeam.value; // NEW
            
            if (dateFilter) {
                filteredTurnovers = filteredTurnovers.filter(t => t.date === dateFilter);
            }
            
            if (shiftFilter !== 'all') {
                filteredTurnovers = filteredTurnovers.filter(t => t.shift === shiftFilter);
            }
            
            // NEW: Filter by team
            if (teamFilter !== 'all') {
                filteredTurnovers = filteredTurnovers.filter(t => t.team === teamFilter);
            }
            
            // Apply pagination
            const totalPages = Math.ceil(filteredTurnovers.length / itemsPerPage);
            currentPagePastTurnover = Math.min(currentPagePastTurnover, Math.max(1, totalPages));
            
            const startIndex = (currentPagePastTurnover - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredTurnovers.slice(startIndex, endIndex);
            
            // Render table
            pastTurnoverTable.innerHTML = pageItems.map(turnover => createPastTurnoverRow(turnover)).join('');
            
            // Render pagination
            renderPastTurnoverPagination(filteredTurnovers.length, currentPagePastTurnover, totalPages);
        }
        
        function createPastTurnoverRow(turnover) {
            const savedDate = turnover.savedAt ? turnover.savedAt.toDate().toLocaleDateString() : 'N/A';
            
            // Truncate long text for table display
            const truncateText = (text, maxLength = 30) => {
                if (!text) return '-';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            };
            
            const scheduledEventsText = turnover.scheduledEvents.length > 0 ? 
                truncateText(turnover.scheduledEvents.join(', ')) : '-';
            const generalInfoText = turnover.generalInfo.length > 0 ? 
                truncateText(turnover.generalInfo.join(', ')) : '-';
            const remindersText = turnover.reminders.length > 0 ? 
                truncateText(turnover.reminders.join(', ')) : '-';
            const onCallUpdatesText = turnover.onCallUpdates.length > 0 ? 
                truncateText(turnover.onCallUpdates.join(', ')) : '-';
            
            return `
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="py-3 px-4 text-xs text-gray-500">${turnover.date}</td>
                    <td class="py-3 px-4">${turnover.shift}</td>
                    <td class="py-3 px-4">${turnover.team || 'N/A'}</td> <!-- NEW -->
                    <td class="py-3 px-4 text-center">${turnover.inProgressCount}</td>
                    <td class="py-3 px-4 text-center">${turnover.resolvedCount}</td>
                    <td class="py-3 px-4 truncate-cell" title="${turnover.scheduledEvents.join('\n') || 'No scheduled events'}">${scheduledEventsText}</td>
                    <td class="py-3 px-4 truncate-cell" title="${turnover.generalInfo.join('\n') || 'No general information'}">${generalInfoText}</td>
                    <td class="py-3 px-4 truncate-cell" title="${turnover.reminders.join('\n') || 'No reminders'}">${remindersText}</td>
                    <td class="py-3 px-4 truncate-cell" title="${turnover.onCallUpdates.join('\n') || 'No on-call updates'}">${onCallUpdatesText}</td>
                    <td class="py-3 px-4 relative">
                        <div class="dropdown-container relative inline-block">
                            <button class="ellipsis-btn text-gray-600 hover:text-blue-600 text-lg font-bold" data-id="${turnover.id}"></button>
                            <div class="dropdown-menu">
                                <button class="dropdown-item view-past-turnover" data-id="${turnover.id}">View Details</button>
                                <button class="dropdown-item delete-past-turnover" data-id="${turnover.id}">Delete</button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function renderPastTurnoverPagination(totalItems, currentPage, totalPages) {
            const paginationContainer = document.getElementById('past-turnover-pagination');
            
            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }
            
            paginationContainer.classList.remove('hidden');
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Previous</button>`;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust if we're at the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" data-page="1">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
            }
            
            // Next button
            paginationHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Next</button>`;
            
            // Info
            paginationHTML += `<span class="pagination-info">Showing ${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)}-${Math.min(currentPage * itemsPerPage, totalItems)} of ${totalItems}</span>`;
            
            paginationContainer.innerHTML = paginationHTML;
            
            // Add event listeners to pagination buttons
            paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!e.target.disabled) {
                        const page = parseInt(e.target.dataset.page);
                        currentPagePastTurnover = page;
                        renderPastTurnovers();
                    }
                });
            });
        }
        
        function viewPastTurnoverDetails(turnover) {
            if (!turnover) return;
            
            // Create a modal to show turnover details
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-xl bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-blue-900">Turnover Details - ${turnover.date} (${turnover.shift})</h3>
                        <button class="text-gray-500 hover:text-gray-700 close-turnover-modal">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-3 rounded-md">
                                <h4 class="font-semibold text-blue-800">In Progress Tickets</h4>
                                <p class="text-2xl font-bold">${turnover.inProgressCount}</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded-md">
                                <h4 class="font-semibold text-green-800">Resolved Tickets</h4>
                                <p class="text-2xl font-bold">${turnover.resolvedCount}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">Scheduled Events</h4>
                            ${turnover.scheduledEvents.length > 0 ? 
                                `<div class="bg-yellow-50 p-3 rounded-md whitespace-pre-line">${turnover.scheduledEvents.join('\n')}</div>` : 
                                '<p class="text-gray-500 italic">No scheduled events</p>'}
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">General Information</h4>
                            ${turnover.generalInfo.length > 0 ? 
                                `<div class="bg-purple-50 p-3 rounded-md whitespace-pre-line">${turnover.generalInfo.join('\n')}</div>` : 
                                '<p class="text-gray-500 italic">No general information</p>'}
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">Reminders</h4>
                            ${turnover.reminders.length > 0 ? 
                                `<div class="bg-pink-50 p-3 rounded-md whitespace-pre-line">${turnover.reminders.join('\n')}</div>` : 
                                '<p class="text-gray-500 italic">No reminders</p>'}
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">On-call Updates</h4>
                            ${turnover.onCallUpdates.length > 0 ? 
                                `<div class="bg-blue-50 p-3 rounded-md whitespace-pre-line">${turnover.onCallUpdates.join('\n')}</div>` : 
                                '<p class="text-gray-500 italic">No on-call updates</p>'}
                        </div>
                        
                        <div class="text-sm text-gray-500 mt-4">
                            Saved by: ${turnover.savedBy} on ${turnover.savedAt ? turnover.savedAt.toDate().toLocaleString() : 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal event
            modal.querySelector('.close-turnover-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        async function deletePastTurnover(turnoverId) {
            if (confirm('Are you sure you want to delete this turnover record? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/pastTurnovers`, turnoverId));
                    showNotification('Turnover record deleted.', 'warning');
                } catch (error) {
                    console.error("Error deleting turnover record: ", error);
                    showNotification('Error deleting turnover record.', 'error');
                }
            }
        }

        // --- NEW: CLEAR FILTER FUNCTIONS ---
        function clearInProgressFilters() {
            document.getElementById('sort-in-progress-date').value = 'newest';
            document.getElementById('sort-in-progress-shift').value = 'default';
            document.getElementById('sort-in-progress-assignee').value = 'default';
            document.getElementById('sort-in-progress-priority').value = 'default';
            document.getElementById('sort-in-progress-environment').value = 'default';
            document.getElementById('sort-in-progress-issue').value = 'default';
            document.getElementById('filter-in-progress-specific-date').value = '';
            
            renderTickets();
            showNotification('In Progress filters cleared', 'info');
        }
        
        function clearResolvedFilters() {
            document.getElementById('sort-resolved-date').value = 'newest';
            document.getElementById('sort-resolved-shift').value = 'default';
            document.getElementById('sort-resolved-assignee').value = 'default';
            document.getElementById('sort-resolved-priority').value = 'default';
            document.getElementById('sort-resolved-environment').value = 'default';
            document.getElementById('sort-resolved-issue').value = 'default';
            document.getElementById('filter-resolved-specific-date').value = '';
            
            renderTickets();
            showNotification('Resolved filters cleared', 'info');
        }

        // --- EVENT LISTENER SETUP ---
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Modal
            addTicketBtn.addEventListener('click', () => openModal());
            cancelModalBtn.addEventListener('click', closeModal);
            ticketForm.addEventListener('submit', handleFormSubmit);
            deleteTicketBtn.addEventListener('click', handleDeleteTicket);
            
            // Sorting and filtering
            document.querySelectorAll('#sort-in-progress-date, #sort-in-progress-shift, #sort-in-progress-assignee, #sort-in-progress-priority, #sort-in-progress-environment, #sort-in-progress-issue, #filter-in-progress-specific-date').forEach(el => {
                el.addEventListener('change', renderTickets);
            });
            
            document.querySelectorAll('#sort-resolved-date, #sort-resolved-shift, #sort-resolved-assignee, #sort-resolved-priority, #sort-resolved-environment, #sort-resolved-issue, #filter-resolved-specific-date').forEach(el => {
                el.addEventListener('change', renderTickets);
            });
            
            // Export buttons
            exportInProgressBtn.addEventListener('click', () => exportTickets('in-progress'));
            exportResolvedBtn.addEventListener('click', () => exportTickets('resolved'));
            
            // Report generation
            generateDailyReportBtn.addEventListener('click', () => generateReport('daily'));
            generateWeeklyReportBtn.addEventListener('click', () => generateReport('weekly'));
            generateMonthlyReportBtn.addEventListener('click', () => generateReport('monthly'));
            takeScreenshotBtn.addEventListener('click', takeReportScreenshot);
            downloadReportBtn.addEventListener('click', downloadReport);
            
            // User selection
            confirmUserBtn.addEventListener('click', confirmUserSelection);
            
            // Past turnover filters
            applyPastTurnoverFilter.addEventListener('click', renderPastTurnovers);
            clearPastTurnoverFilter.addEventListener('click', () => {
                filterPastTurnoverDate.value = '';
                filterPastTurnoverShift.value = 'all';
                filterPastTurnoverTeam.value = 'all'; // NEW
                renderPastTurnovers();
                showNotification('Past turnover filters cleared', 'info');
            });
        }

        // --- EXPORT FUNCTIONALITY ---
        function exportTickets(type) {
            let ticketsToExport = [];
            let period = '';
            
            if (type === 'in-progress') {
                ticketsToExport = allTickets.filter(t => t.status !== 'Resolved');
                period = exportInProgressPeriod.value;
            } else {
                ticketsToExport = allTickets.filter(t => t.status === 'Resolved');
                period = exportResolvedPeriod.value;
            }
            
            // Filter by period
            const now = new Date();
            ticketsToExport = ticketsToExport.filter(ticket => {
                let ticketDate;
                if (ticket.ticketDate) {
                    ticketDate = new Date(ticket.ticketDate);
                } else if (ticket.createdAt) {
                    ticketDate = ticket.createdAt.toDate();
                } else {
                    return false;
                }
                
                if (period === 'day') {
                    return ticketDate.toDateString() === now.toDateString();
                } else if (period === 'month') {
                    return ticketDate.getMonth() === now.getMonth() && 
                           ticketDate.getFullYear() === now.getFullYear();
                } else if (period === 'year') {
                    return ticketDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
            
            if (ticketsToExport.length === 0) {
                showNotification('No tickets to export for the selected period.', 'info');
                return;
            }
            
            // Prepare data for export
            const headers = type === 'in-progress' ? 
                ['Date', 'Shift', 'Handled By', 'Ticket #', 'Priority', 'Environment', 'Status', 'Issue/Request', 'Description', 'Resolution', 'Age'] :
                ['Date', 'Shift', 'Handled By', 'Ticket #', 'Priority', 'Environment', 'Issue/Request', 'Description', 'Resolution', 'Resolved On'];
                
            const data = ticketsToExport.map(ticket => {
                const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toLocaleDateString() : 
                                  (ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A');
                const resolvedDate = ticket.resolvedAt ? ticket.resolvedAt.toDate().toLocaleDateString() : 'N/A';
                const age = ticket.createdAt ? formatDistanceToNow(ticket.createdAt.toDate()) : 'N/A';
                
                if (type === 'in-progress') {
                    return [
                        ticketDate,
                        ticket.shift,
                        ticket.handledBy,
                        ticket.ticketNumber,
                        ticket.priority,
                        ticket.environment || 'N/A',
                        ticket.status,
                        ticket.issueType || 'Not specified',
                        ticket.description || 'No description',
                        ticket.resolution || 'No resolution yet',
                        age
                    ];
                } else {
                    return [
                        ticketDate,
                        ticket.shift,
                        ticket.handledBy,
                        ticket.ticketNumber,
                        ticket.priority,
                        ticket.environment || 'N/A',
                        ticket.issueType || 'Not specified',
                        ticket.description || 'No description',
                        ticket.resolution || 'No resolution',
                        resolvedDate
                    ];
                }
            });
            
            // Create worksheet and workbook
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, type === 'in-progress' ? 'In Progress Tickets' : 'Resolved Tickets');
            
            // Generate file name
            const periodText = period === 'day' ? 'Today' : period === 'month' ? 'ThisMonth' : 'ThisYear';
            const fileName = `${type === 'in-progress' ? 'InProgress' : 'Resolved'}Tickets_${periodText}_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Export
            XLSX.writeFile(wb, fileName);
            showNotification(`Exported ${ticketsToExport.length} ${type.replace('-', ' ')} tickets`, 'success');
        }

        // --- REPORTING ---
        function generateReport(type) {
            currentReportType = type;
            
            // Show/hide buttons based on report type
            takeScreenshotBtn.classList.remove('hidden');
            downloadReportBtn.classList.remove('hidden');
            
            // Calculate date range based on report type
            const now = new Date();
            let startDate, endDate, periodText;
            
            switch(type) {
                case 'daily':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    periodText = `Daily Report - ${now.toLocaleDateString()}`;
                    break;
                case 'weekly':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setDate(now.getDate() + (6 - now.getDay())); // End of week (Saturday)
                    endDate.setHours(23, 59, 59, 999);
                    periodText = `Weekly Report - ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
                    break;
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    periodText = `Monthly Report - ${now.toLocaleString('default', { month: 'long' })} ${now.getFullYear()}`;
                    break;
            }
            
            // Filter tickets for the report period
            const reportTickets = allTickets.filter(ticket => {
                let ticketDate;
                if (ticket.ticketDate) {
                    ticketDate = new Date(ticket.ticketDate);
                } else if (ticket.createdAt) {
                    ticketDate = ticket.createdAt.toDate();
                } else {
                    return false;
                }
                return ticketDate >= startDate && ticketDate <= endDate;
            });
            
            // Store report data for download
            reportData = {
                type: type,
                period: periodText,
                tickets: reportTickets,
                generatedAt: new Date()
            };
            
            // Update period display
            reportPeriodDisplay.textContent = periodText;
            reportPeriodDisplay.classList.remove('hidden');
            
            // Generate report content
            generateReportContent(reportTickets, periodText);
        }
        
        function generateReportContent(tickets, periodText) {
            const reportOutput = document.getElementById('report-output');
            
            // Calculate statistics
            const totalTickets = tickets.length;
            const resolvedTickets = tickets.filter(t => t.status === 'Resolved').length;
            const inProgressTickets = totalTickets - resolvedTickets;
            const resolutionRate = totalTickets > 0 ? Math.round((resolvedTickets / totalTickets) * 100) : 0;
            
            // Calculate average resolution time
            let totalResolutionTime = 0;
            let resolvedWithTime = 0;
            
            tickets.filter(t => t.status === 'Resolved' && t.createdAt && t.resolvedAt).forEach(ticket => {
                const created = ticket.createdAt.toDate();
                const resolved = ticket.resolvedAt.toDate();
                totalResolutionTime += (resolved - created) / (1000 * 60 * 60); // Hours
                resolvedWithTime++;
            });
            
            const avgResolutionTime = resolvedWithTime > 0 ? Math.round(totalResolutionTime / resolvedWithTime) : 0;
            
            // Priority distribution
            const priorityCounts = { P1: 0, P2: 0, P3: 0, P4: 0 };
            tickets.forEach(ticket => {
                if (ticket.priority && priorityCounts.hasOwnProperty(ticket.priority)) {
                    priorityCounts[ticket.priority]++;
                }
            });
            
            // Shift distribution
            const shiftCounts = { Day: 0, Night: 0 };
            tickets.forEach(ticket => {
                if (ticket.shift && shiftCounts.hasOwnProperty(ticket.shift)) {
                    shiftCounts[ticket.shift]++;
                }
            });
            
            // Issue type distribution
            const issueCounts = {};
            tickets.forEach(ticket => {
                if (ticket.issueType) {
                    issueCounts[ticket.issueType] = (issueCounts[ticket.issueType] || 0) + 1;
                }
            });
            
            // Environment distribution
            const environmentCounts = {};
            tickets.forEach(ticket => {
                const env = ticket.environment || 'N/A';
                environmentCounts[env] = (environmentCounts[env] || 0) + 1;
            });
            
            // Status trend (last 7 days)
            const statusTrend = {};
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayTickets = tickets.filter(t => {
                    const ticketDate = t.ticketDate ? new Date(t.ticketDate).toISOString().split('T')[0] : 
                                      (t.createdAt ? t.createdAt.toDate().toISOString().split('T')[0] : '');
                    return ticketDate === dateStr;
                });
                
                statusTrend[dateStr] = {
                    resolved: dayTickets.filter(t => t.status === 'Resolved').length,
                    inProgress: dayTickets.filter(t => t.status !== 'Resolved').length
                };
            }
            
            // Generate HTML for the report
            reportOutput.innerHTML = `
                <!-- Key Statistics -->
                <div class="col-span-full grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="stats-card stats-resolved">
                        <h3 class="text-lg font-bold mb-2">Resolved Tickets</h3>
                        <div class="text-3xl font-bold">${resolvedTickets}</div>
                        <div class="text-sm text-gray-600 mt-1">${resolutionRate}% resolution rate</div>
                    </div>
                    <div class="stats-card stats-in-progress">
                        <h3 class="text-lg font-bold mb-2">In Progress</h3>
                        <div class="text-3xl font-bold">${inProgressTickets}</div>
                        <div class="text-sm text-gray-600 mt-1">${totalTickets} total tickets</div>
                    </div>
                    <div class="stats-card stats-age">
                        <h3 class="text-lg font-bold mb-2">Avg. Resolution Time</h3>
                        <div class="text-3xl font-bold">${avgResolutionTime}h</div>
                        <div class="text-sm text-gray-600 mt-1">Based on ${resolvedWithTime} resolved tickets</div>
                    </div>
                </div>
                
                <!-- Charts Row 1 -->
                <div class="chart-card trend-chart">
                    <h3 class="text-lg font-bold mb-4">Ticket Trend (Last 7 Days)</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card shift-chart">
                    <h3 class="text-lg font-bold mb-4">Tickets by Shift</h3>
                    <div class="chart-container">
                        <canvas id="shiftChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card status-chart">
                    <h3 class="text-lg font-bold mb-4">Tickets by Status</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                
                <!-- Charts Row 2 -->
                <div class="chart-card issue-chart">
                    <h3 class="text-lg font-bold mb-4">Tickets by Issue Type</h3>
                    <div class="chart-container">
                        <canvas id="issueChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card priority-chart">
                    <h3 class="text-lg font-bold mb-4">Tickets by Priority</h3>
                    <div class="chart-container">
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card environment-chart">
                    <h3 class="text-lg font-bold mb-4">Tickets by Environment</h3>
                    <div class="chart-container">
                        <canvas id="environmentChart"></canvas>
                    </div>
                </div>
            `;
            
            // Render charts after a brief delay to ensure DOM is ready
            setTimeout(() => {
                renderCharts({
                    trend: statusTrend,
                    shift: shiftCounts,
                    status: { 'Resolved': resolvedTickets, 'In Progress': inProgressTickets },
                    issue: issueCounts,
                    priority: priorityCounts,
                    environment: environmentCounts
                });
            }, 100);
        }
        
        function renderCharts(data) {
            // Trend Chart (Line Chart)
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const trendLabels = Object.keys(data.trend);
            const resolvedData = trendLabels.map(date => data.trend[date].resolved);
            const inProgressData = trendLabels.map(date => data.trend[date].inProgress);
            
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {
                            label: 'Resolved',
                            data: resolvedData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'In Progress',
                            data: inProgressData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Shift Chart (Doughnut)
            const shiftCtx = document.getElementById('shiftChart').getContext('2d');
            new Chart(shiftCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.shift),
                    datasets: [{
                        data: Object.values(data.shift),
                        backgroundColor: ['#f59e0b', '#1e40af'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Status Chart (Doughnut)
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.status),
                    datasets: [{
                        data: Object.values(data.status),
                        backgroundColor: ['#10b981', '#3b82f6'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Issue Chart (Bar)
            const issueCtx = document.getElementById('issueChart').getContext('2d');
            const issueLabels = Object.keys(data.issue);
            const issueData = Object.values(data.issue);
            
            // Sort issues by count (descending) and take top 10
            const sortedIssues = issueLabels.map((label, index) => ({
                label,
                count: issueData[index]
            })).sort((a, b) => b.count - a.count).slice(0, 10);
            
            new Chart(issueCtx, {
                type: 'bar',
                data: {
                    labels: sortedIssues.map(i => i.label),
                    datasets: [{
                        label: 'Tickets',
                        data: sortedIssues.map(i => i.count),
                        backgroundColor: '#f97316',
                        borderColor: '#c2410c',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    indexAxis: 'y'
                }
            });
            
            // Priority Chart (Pie)
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data.priority),
                    datasets: [{
                        data: Object.values(data.priority),
                        backgroundColor: ['#dc2626', '#ea580c', '#ca8a04', '#1d4ed8'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Environment Chart (Doughnut)
            const environmentCtx = document.getElementById('environmentChart').getContext('2d');
            new Chart(environmentCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.environment),
                    datasets: [{
                        data: Object.values(data.environment),
                        backgroundColor: ['#166534', '#92400e', '#4b5563'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        async function takeReportScreenshot() {
            try {
                showNotification('Taking report screenshot...', 'info');
                
                const reportContent = document.getElementById('report-screenshot-content');
                const canvas = await html2canvas(reportContent, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });
                
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `TicketReport_${currentReportType}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = image;
                link.click();
                
                showNotification('Report screenshot downloaded!', 'success');
            } catch (error) {
                console.error('Error taking report screenshot:', error);
                showNotification('Error taking report screenshot.', 'error');
            }
        }
        
        function downloadReport() {
            if (!reportData) {
                showNotification('No report data to download.', 'info');
                return;
            }
            
            // Prepare data for Excel export
            const headers = ['Date', 'Shift', 'Handled By', 'Ticket #', 'Priority', 'Environment', 'Status', 'Issue/Request', 'Description', 'Resolution', 'Created', 'Resolved'];
            
            const data = reportData.tickets.map(ticket => {
                const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toLocaleDateString() : 
                                  (ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A');
                const createdDate = ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A';
                const resolvedDate = ticket.resolvedAt ? ticket.resolvedAt.toDate().toLocaleDateString() : 'N/A';
                
                return [
                    ticketDate,
                    ticket.shift,
                    ticket.handledBy,
                    ticket.ticketNumber,
                    ticket.priority,
                    ticket.environment || 'N/A',
                    ticket.status,
                    ticket.issueType || 'Not specified',
                    ticket.description || 'No description',
                    ticket.resolution || 'No resolution',
                    createdDate,
                    resolvedDate
                ];
            });
            
            // Create worksheet and workbook
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ticket Report');
            
            // Add summary sheet
            const summaryData = [
                ['Report Type', reportData.type],
                ['Report Period', reportData.period],
                ['Total Tickets', reportData.tickets.length],
                ['Resolved Tickets', reportData.tickets.filter(t => t.status === 'Resolved').length],
                ['In Progress Tickets', reportData.tickets.filter(t => t.status !== 'Resolved').length],
                ['Generated At', reportData.generatedAt.toLocaleString()]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Generate file name
            const fileName = `TicketReport_${currentReportType}_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Export
            XLSX.writeFile(wb, fileName);
            showNotification('Report downloaded as Excel file', 'success');
        }

        // --- UTILITY FUNCTIONS ---
        function formatDistanceToNow(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInDays === 0) {
                const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
                if (diffInHours === 0) {
                    const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
                    return `${diffInMinutes}m`;
                }
                return `${diffInHours}h`;
            } else if (diffInDays === 1) {
                return '1d';
            } else {
                return `${diffInDays}d`;
            }
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'Resolved': return 'bg-green-100 text-green-800';
                case 'In Progress': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
