<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Ticket Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas for screenshot functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f7ff; /* Light Blue */
            color: #1e3a8a; /* Dark Blue */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for active tab */
        .tab-active {
            border-bottom-color: #1d4ed8; /* Dark Blue */
            color: #1d4ed8; /* Dark Blue */
        }
        /* Notification toast animation */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .toast {
            animation: fadeInOut 4s ease-in-out forwards;
        }
        /* Priority colors */
        .priority-P1 { background-color: #fee2e2; color: #dc2626; }
        .priority-P2 { background-color: #fed7aa; color: #ea580c; }
        .priority-P3 { background-color: #fef08a; color: #ca8a04; }
        .priority-P4 { background-color: #dbeafe; color: #1d4ed8; }
        /* Text truncation for table cells */
        .truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .truncate-description {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Dropdown menu styles */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            min-width: 120px;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        .dropdown-item.resolve {
            color: #059669;
        }
        .dropdown-item.edit {
            color: #2563eb;
        }
        /* Add contrasting background for text areas */
        textarea {
            background-color: #f8fafc; /* Light gray background */
            color: #1e293b; /* Dark slate text color */
            border: 1px solid #cbd5e1; /* Border color */
        }
        
        textarea:focus {
            background-color: #ffffff; /* White when focused */
            outline: 2px solid #3b82f6; /* Blue focus ring */
            outline-offset: -1px;
        }
        /* New Ticket Modal Color Scheme */
        .modal-label {
            font-weight: 700;
            color: #1e3a8a; /* Dark Blue */
            font-size: 0.875rem;
        }
        .modal-input, .modal-select, .modal-textarea {
            background-color: #f0f7ff; /* Light Blue */
            color: #1e3a8a; /* Dark Blue */
            border: 1px solid #bfdbfe; /* Light Blue Border */
            border-radius: 0.375rem;
        }
        .modal-input:focus, .modal-select:focus, .modal-textarea:focus {
            background-color: #ffffff; /* White when focused */
            outline: 2px solid #1d4ed8; /* Dark Blue focus ring */
            outline-offset: -1px;
            border-color: #1d4ed8;
        }
        .modal-header {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 700;
        }
        .modal-save-btn {
            background-color: #1d4ed8; /* Dark Blue */
            color: white;
        }
        .modal-save-btn:hover {
            background-color: #1e40af; /* Darker Blue */
        }
        .modal-cancel-btn {
            background-color: #f1f5f9; /* Light Gray */
            color: #475569; /* Slate Gray */
        }
        .modal-cancel-btn:hover {
            background-color: #e2e8f0; /* Slightly Darker Gray */
        }
        .modal-delete-btn {
            background-color: #dc2626; /* Red */
            color: white;
        }
        .modal-delete-btn:hover {
            background-color: #b91c1c; /* Darker Red */
        }
        /* Chart container styles */
        .chart-container {
            height: 300px;
            position: relative;
        }
        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover {
            background-color: #f3f4f6;
        }
        .pagination-btn.active {
            background-color: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-info {
            margin: 0 1rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        /* Enhanced label styles */
        .enhanced-label {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        .section-header {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .filter-label {
            color: #1e3a8a; /* Dark Blue */
            font-weight: 600;
            font-size: 0.875rem;
        }
        /* Report period display */
        .report-period {
            background-color: #dbeafe;
            color: #1e3a8a;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
            border-left: 4px solid #1d4ed8;
        }
        /* Screenshot button */
        .screenshot-btn {
            background-color: #059669;
            color: white;
        }
        .screenshot-btn:hover {
            background-color: #047857;
        }
        /* User presence indicator */
        .user-presence {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981; /* Green for online */
        }
        .user-status.offline {
            background-color: #6b7280; /* Gray for offline */
        }
        .online-users {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            z-index: 40;
            max-width: 200px;
        }
        .online-users-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e3a8a;
        }
        .online-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* Edit conflict modal */
        .edit-conflict-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .edit-conflict-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
        }
        /* Real-time update indicator */
        .real-time-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            z-index: 50;
            display: none;
        }
        /* Turnover section styles */
        .turnover-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .turnover-section-header {
            color: #1e3a8a;
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #dbeafe;
            padding-bottom: 0.5rem;
        }
        .turnover-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .turnover-item:last-child {
            border-bottom: none;
        }
        .turnover-item-content {
            flex-grow: 1;
        }
        .turnover-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        .turnover-add-btn {
            background-color: #1d4ed8;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .turnover-add-btn:hover {
            background-color: #1e40af;
        }
        .turnover-input-group {
            margin-bottom: 1rem;
        }
        /* Hide edit/delete buttons during screenshot */
        .screenshot-mode .turnover-item-actions {
            display: none !important;
        }
        .screenshot-mode .turnover-input-group {
            display: none !important;
        }
        .screenshot-mode #takeTurnoverScreenshotBtn {
            display: none !important;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Real-time Update Indicator -->
    <div id="realTimeIndicator" class="real-time-indicator">
        <span id="updateMessage">Update received</span>
    </div>

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-900">Ticket Tracker</h1>
            <div class="mt-4 sm:mt-0 flex items-center gap-4">
                <div class="user-presence">
                    <div id="currentUserAvatar" class="user-avatar bg-blue-600">U</div>
                    <span id="currentUserName" class="text-sm font-medium">User</span>
                    <div id="currentUserStatus" class="user-status"></div>
                </div>
                <button id="addTicketBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    + New Ticket
                </button>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="in-progress">
                    In Progress
                </button>
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="resolved">
                    Resolved
                </button>
                <!-- NEW: Turnover Tab -->
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="turnover">
                    Turnover
                </button>
                <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="reports">
                    Reports
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- In Progress Tickets -->
            <div id="in-progress-content" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">In Progress Tickets</h2>
                    <div class="mb-4 flex flex-wrap gap-4 items-center">
                       <span class="filter-label">Sort by:</span>
                        <select id="sort-in-progress-date" class="sort-control border rounded-md p-2 text-sm">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                        <select id="sort-in-progress-shift" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Shifts</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                        <select id="sort-in-progress-assignee" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Assignees</option>
                        </select>
                        <select id="sort-in-progress-priority" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Priorities</option>
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                        </select>
                        <select id="sort-in-progress-issue" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Issues</option>
                            <option value="Zena Failed Jobs - BPI">Zena Failed Jobs - BPI</option>
                            <option value="Zena Failed Jobs - DB">Zena Failed Jobs - DB</option>
                            <option value="Netcool Alert">Netcool Alert</option>
                            <option value="PagerDuty Alert">PagerDuty Alert</option>
                            <option value="PowerBroker (SDDC)">PowerBroker (SDDC)</option>
                            <option value="PowerBroker (Cloud AWS)">PowerBroker (Cloud AWS)</option>
                            <option value="CSOC - Phishing Email">CSOC - Phishing Email</option>
                            <option value="Service Request - Data Center Access">Service Request - Data Center Access</option>
                        </select>
                        <input type="date" id="filter-in-progress-specific-date" class="sort-control border rounded-md p-2 text-sm">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Shift</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Handled By</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Ticket #</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Priority</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Status</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Issue/Request</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Description</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolution</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Age</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="in-progress-tickets-table" class="divide-y divide-gray-200">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination for In Progress -->
                    <div id="in-progress-pagination" class="pagination mt-4 hidden">
                        <!-- Pagination buttons will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Resolved Tickets -->
            <div id="resolved-content" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Resolved Tickets</h2>
                     <div class="mb-4 flex flex-wrap gap-4 items-center">
                       <span class="filter-label">Sort by:</span>
                        <select id="sort-resolved-date" class="sort-control border rounded-md p-2 text-sm">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                        <select id="sort-resolved-shift" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Shifts</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                        <select id="sort-resolved-assignee" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Assignees</option>
                        </select>
                        <select id="sort-resolved-priority" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Priorities</option>
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                        </select>
                        <select id="sort-resolved-issue" class="sort-control border rounded-md p-2 text-sm">
                            <option value="default">All Issues</option>
                            <option value="Zena Failed Jobs - BPI">Zena Failed Jobs - BPI</option>
                            <option value="Zena Failed Jobs - DB">Zena Failed Jobs - DB</option>
                            <option value="Netcool Alert">Netcool Alert</option>
                            <option value="PagerDuty Alert">PagerDuty Alert</option>
                            <option value="PowerBroker (SDDC)">PowerBroker (SDDC)</option>
                            <option value="PowerBroker (Cloud AWS)">PowerBroker (Cloud AWS)</option>
                            <option value="CSOC - Phishing Email">CSOC - Phishing Email</option>
                            <option value="Service Request - Data Center Access">Service Request - Data Center Access</option>
                        </select>
                        <input type="date" id="filter-resolved-specific-date" class="sort-control border rounded-md p-2 text-sm">
                    </div>
                    <div class="overflow-x-auto">
                         <table class="min-w-full bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Shift</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Handled By</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Ticket #</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Priority</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Issue/Request</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Description</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolution</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Resolved On</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-blue-900 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resolved-tickets-table" class="divide-y divide-gray-200">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination for Resolved -->
                    <div id="resolved-pagination" class="pagination mt-4 hidden">
                        <!-- Pagination buttons will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- NEW: Turnover Tab -->
            <div id="turnover-content" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Turnover</h2>
                    <button id="takeTurnoverScreenshotBtn" class="screenshot-btn font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 mb-4">
                        Take Turnover Screenshot
                    </button>
                    
                    <!-- Section 1: Date and Shift -->
                    <div class="turnover-section">
                        <h3 class="turnover-section-header">Date and Shift</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="turnover-input-group">
                                <label for="turnover-date" class="enhanced-label">Date</label>
                                <input type="date" id="turnover-date" class="w-full p-2 border rounded-md">
                            </div>
                            <div class="turnover-input-group">
                                <label for="turnover-shift" class="enhanced-label">Shift</label>
                                <select id="turnover-shift" class="w-full p-2 border rounded-md">
                                    <option value="Day Shift">Day Shift</option>
                                    <option value="Night Shift">Night Shift</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Tickets Handled - UPDATED TO SHOW COUNTS ONLY -->
                    <div class="turnover-section">
                        <h3 class="turnover-section-header">Tickets Handled</h3>
                        <div id="turnover-tickets-container">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">In Progress Tickets</h4>
                                    <div id="turnover-in-progress-count" class="bg-blue-50 p-4 rounded-md text-center">
                                        <div class="text-3xl font-bold text-blue-700">0</div>
                                        <div class="text-sm text-blue-600">Tickets</div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-2">Resolved Tickets</h4>
                                    <div id="turnover-resolved-count" class="bg-green-50 p-4 rounded-md text-center">
                                        <div class="text-3xl font-bold text-green-700">0</div>
                                        <div class="text-sm text-green-600">Tickets</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Scheduled Events -->
                    <div class="turnover-section">
                        <h3 class="turnover-section-header">Scheduled Events</h3>
                        <div id="turnover-scheduled-events">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <input type="text" id="new-scheduled-event" placeholder="Add new scheduled event" class="w-full p-2 border rounded-md">
                            <button id="add-scheduled-event" class="turnover-add-btn">Add Event</button>
                        </div>
                    </div>
                    
                    <!-- Section 4: General Information -->
                    <div class="turnover-section">
                        <h3 class="turnover-section-header">General Information</h3>
                        <div id="turnover-general-info">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <input type="text" id="new-general-info" placeholder="Add new general information" class="w-full p-2 border rounded-md">
                            <button id="add-general-info" class="turnover-add-btn">Add Information</button>
                        </div>
                    </div>
                    
                    <!-- Section 5: Reminders -->
                    <div class="turnover-section">
                        <h3 class="turnover-section-header">Reminders</h3>
                        <div id="turnover-reminders">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <input type="text" id="new-reminder" placeholder="Add new reminder" class="w-full p-2 border rounded-md">
                            <button id="add-reminder" class="turnover-add-btn">Add Reminder</button>
                        </div>
                    </div>
                    
                    <!-- Section 6: On-call Updates -->
                    <div class="turnover-section">
                        <h3 class="turnover-section-header">On-call Updates</h3>
                        <div id="turnover-oncall-updates">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="turnover-input-group">
                            <input type="text" id="new-oncall-update" placeholder="Add new on-call update" class="w-full p-2 border rounded-md">
                            <button id="add-oncall-update" class="turnover-add-btn">Add Update</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports -->
            <div id="reports-content" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="section-header">Reports</h2>
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button id="generateDailyReportBtn" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Generate Daily Report</button>
                        <button id="generateWeeklyReportBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Generate Weekly Report</button>
                        <button id="generateMonthlyReportBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Generate Monthly Report</button>
                        <button id="takeScreenshotBtn" class="screenshot-btn font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 hidden">Take Screenshot</button>
                        <button id="downloadReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 hidden">Download Report (Excel)</button>
                    </div>
                    
                    <!-- Report Period Display -->
                    <div id="report-period-display" class="report-period hidden">
                        <!-- Period information will be displayed here -->
                    </div>
                    
                    <!-- Report content for screenshot -->
                    <div id="report-screenshot-content">
                        <div id="report-output" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                           <!-- Report charts and stats will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Online Users Panel -->
    <div id="onlineUsersPanel" class="online-users hidden">
        <div class="online-users-header">Online Users</div>
        <div id="onlineUsersList"></div>
    </div>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                 <h3 class="text-lg leading-6 font-medium modal-header" id="modalTitle">New Ticket</h3>
                 <form id="ticketForm" class="mt-2 space-y-4 text-left p-4">
                    <input type="hidden" id="ticketId">
                    <input type="hidden" id="ticketVersion" value="0">
                    <div>
                        <label for="ticketDate" class="enhanced-label">Date</label>
                        <input type="date" id="ticketDate" name="ticketDate" required class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-input">
                    </div>
                    <div>
                        <label for="shift" class="enhanced-label">Shift</label>
                        <select id="shift" name="shift" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Shift</option>
                            <option>Day</option>
                            <option>Night</option>
                        </select>
                    </div>
                    <div>
                        <label for="handledBy" class="enhanced-label">Handled By</label>
                        <select id="handledBy" name="handledBy" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Assignee</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label for="ticketNumber" class="enhanced-label">Ticket Number</label>
                        <input type="text" id="ticketNumber" name="ticketNumber" required class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-input">
                    </div>
                    <div>
                        <label for="priority" class="enhanced-label">Priority</label>
                        <select id="priority" name="priority" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Priority</option>
                            <option>P1</option>
                            <option>P2</option>
                            <option>P3</option>
                            <option>P4</option>
                        </select>
                    </div>
                    <div>
                        <label for="issueType" class="enhanced-label">Issue/Request</label>
                        <select id="issueType" name="issueType" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Issue Type</option>
                            <option value="Zena Failed Jobs - BPI">Zena Failed Jobs - BPI</option>
                            <option value="Zena Failed Jobs - DB">Zena Failed Jobs - DB</option>
                            <option value="Netcool Alert">Netcool Alert</option>
                            <option value="PagerDuty Alert">PagerDuty Alert</option>
                            <option value="PowerBroker (SDDC)">PowerBroker (SDDC)</option>
                            <option value="PowerBroker (Cloud AWS)">PowerBroker (Cloud AWS)</option>
                            <option value="CSOC - Phishing Email">CSOC - Phishing Email</option>
                            <option value="Service Request - Data Center Access">Service Request - Data Center Access</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="enhanced-label">Description</label>
                        <textarea id="description" name="description" rows="3" required class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-textarea"></textarea>
                    </div>
                    <div>
                        <label for="resolution" class="enhanced-label">Resolution</label>
                        <textarea id="resolution" name="resolution" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm rounded-md p-2 modal-textarea"></textarea>
                    </div>
                    <div>
                        <label for="status" class="enhanced-label">Status</label>
                        <select id="status" name="status" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md modal-select">
                            <option value="" disabled selected>Select Status</option>
                            <option>In Progress</option>
                            <option>Resolved</option>
                        </select>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="saveTicketBtn" type="submit" class="px-4 py-2 text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 modal-save-btn">Save</button>
                        <button id="cancelModalBtn" type="button" class="mt-2 px-4 py-2 text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300 modal-cancel-btn">Cancel</button>
                        <button id="deleteTicketBtn" type="button" class="mt-4 px-4 py-2 text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-red-300 modal-delete-btn hidden">Delete Ticket</button>
                    </div>
                 </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Conflict Modal -->
    <div id="editConflictModal" class="edit-conflict-modal hidden">
        <div class="edit-conflict-content">
            <h3 class="text-lg font-bold mb-4">Edit Conflict</h3>
            <p class="mb-4">This ticket has been modified by another user since you started editing. How would you like to proceed?</p>
            <div class="flex gap-4">
                <button id="overwriteChangesBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Overwrite Their Changes</button>
                <button id="reloadTicketBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md">Reload Their Version</button>
                <button id="cancelEditBtn" class="px-4 py-2 bg-red-600 text-white rounded-md">Cancel Edit</button>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-5 right-5 z-[100]"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, serverTimestamp, query, orderBy, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYSpKkDqkOtw34ed51EoeFMbuhvcJmHkc",
            authDomain: "ops-manila.firebaseapp.com",
            projectId: "ops-manila",
            storageBucket: "ops-manila.firebasestorage.app",
            messagingSenderId: "362005177325",
            appId: "1:362005177325:web:130e47f47992089ce03de4",
            measurementId: "G-W3VQBSBWY5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Global State
        const assigneesList = ['Geron', 'John Mick', 'Nelson', 'Anna', 'Judy', 'Joyce', 'Ceriaco', 'Jonnie', 'Danica', 'Jake', 'Joseph', 'Jeremiah'];
        const appId = 'ticket-tracker-app'; // Fixed app ID for collection path
        let allTickets = [];
        let reportData = null; // To store generated report data for download
        let currentReportType = null; // Track current report type
        
        // Pagination state
        const itemsPerPage = 15;
        let currentPageInProgress = 1;
        let currentPageResolved = 1;
        
        // Real-time collaboration state
        let currentUser = null;
        let onlineUsers = {};
        let userSessionId = null;
        let editingTicketId = null;
        let editingTicketVersion = 0;

        // NEW: Turnover state
        let turnoverData = {
            date: new Date().toISOString().split('T')[0],
            shift: 'Day Shift',
            scheduledEvents: [],
            generalInfo: [],
            reminders: [],
            onCallUpdates: []
        };

        // DOM Elements
        const addTicketBtn = document.getElementById('addTicketBtn');
        const modal = document.getElementById('ticketModal');
        const modalTitle = document.getElementById('modalTitle');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const ticketForm = document.getElementById('ticketForm');
        const saveTicketBtn = document.getElementById('saveTicketBtn');
        const deleteTicketBtn = document.getElementById('deleteTicketBtn');
        const reportPeriodDisplay = document.getElementById('report-period-display');
        const takeScreenshotBtn = document.getElementById('takeScreenshotBtn');
        const onlineUsersPanel = document.getElementById('onlineUsersPanel');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserStatus = document.getElementById('currentUserStatus');
        const realTimeIndicator = document.getElementById('realTimeIndicator');
        const updateMessage = document.getElementById('updateMessage');
        const editConflictModal = document.getElementById('editConflictModal');
        const overwriteChangesBtn = document.getElementById('overwriteChangesBtn');
        const reloadTicketBtn = document.getElementById('reloadTicketBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const generateDailyReportBtn = document.getElementById('generateDailyReportBtn');
        const generateWeeklyReportBtn = document.getElementById('generateWeeklyReportBtn');
        const generateMonthlyReportBtn = document.getElementById('generateMonthlyReportBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const takeTurnoverScreenshotBtn = document.getElementById('takeTurnoverScreenshotBtn');
        
        // NEW: Turnover DOM Elements
        const turnoverDateInput = document.getElementById('turnover-date');
        const turnoverShiftSelect = document.getElementById('turnover-shift');
        const turnoverInProgressCount = document.getElementById('turnover-in-progress-count');
        const turnoverResolvedCount = document.getElementById('turnover-resolved-count');
        const turnoverScheduledEvents = document.getElementById('turnover-scheduled-events');
        const turnoverGeneralInfo = document.getElementById('turnover-general-info');
        const turnoverReminders = document.getElementById('turnover-reminders');
        const turnoverOncallUpdates = document.getElementById('turnover-oncall-updates');
        const newScheduledEventInput = document.getElementById('new-scheduled-event');
        const addScheduledEventBtn = document.getElementById('add-scheduled-event');
        const newGeneralInfoInput = document.getElementById('new-general-info');
        const addGeneralInfoBtn = document.getElementById('add-general-info');
        const newReminderInput = document.getElementById('new-reminder');
        const addReminderBtn = document.getElementById('add-reminder');
        const newOncallUpdateInput = document.getElementById('new-oncall-update');
        const addOncallUpdateBtn = document.getElementById('add-oncall-update');
        
        // --- MAIN APP INITIALIZATION ---
        function initApp() {
            // Initialize user session
            initializeUserSession();
            
            // Set up real-time listeners
            setupRealtimeListeners();
            
            setupEventListeners();
            populateStaticAssigneeDropdowns();
            switchTab('in-progress');
            
            // Show online users panel on hover
            setupOnlineUsersPanel();
            
            // NEW: Initialize turnover
            initializeTurnover();
        }
        
        // --- REAL-TIME COLLABORATION ---
        function initializeUserSession() {
            // Generate a unique session ID for this user
            userSessionId = 'user-' + Math.random().toString(36).substring(2, 15);
            
            // Get or create user name
            let userName = localStorage.getItem('ticketTrackerUserName');
            if (!userName) {
                userName = prompt('Please enter your name to start collaborating:') || 'Anonymous User';
                localStorage.setItem('ticketTrackerUserName', userName);
            }
            
            currentUser = {
                id: userSessionId,
                name: userName,
                lastSeen: serverTimestamp(),
                online: true
            };
            
            // Update UI with user info
            currentUserName.textContent = currentUser.name;
            currentUserAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            currentUserAvatar.style.backgroundColor = generateUserColor(currentUser.id);
            
            // Register user in the online users collection
            registerUserPresence();
        }
        
        function generateUserColor(userId) {
            // Generate a consistent color based on user ID
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 60%)`;
        }
        
        function registerUserPresence() {
            if (!currentUser) return;
            
            const userRef = doc(db, `/artifacts/${appId}/public/data/onlineUsers`, currentUser.id);
            
            // Set user as online
            setDoc(userRef, {
                ...currentUser,
                lastSeen: serverTimestamp(),
                online: true
            });
            
            // Set up cleanup on page unload
            window.addEventListener('beforeunload', () => {
                setDoc(userRef, {
                    ...currentUser,
                    lastSeen: serverTimestamp(),
                    online: false
                }, { merge: true });
            });
        }
        
        function setupRealtimeListeners() {
            // Tickets collection listener
            const ticketsCollectionRef = collection(db, `/artifacts/${appId}/public/data/tickets`);
            const q = query(ticketsCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const previousTicketCount = allTickets.length;
                allTickets = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // Add version for optimistic concurrency control
                    _version: doc.data()._version || 0
                }));
                
                // Show real-time update indicator if this isn't the initial load
                if (previousTicketCount > 0) {
                    showRealTimeUpdate();
                }
                
                renderTickets();
                
                // NEW: Update turnover tickets if turnover tab is active
                if (!document.getElementById('turnover-content').classList.contains('hidden')) {
                    updateTurnoverTickets();
                }
                
                // Auto-refresh report if reports tab is active and a report type is selected
                if (!document.getElementById('reports-content').classList.contains('hidden') && currentReportType) {
                    generateReport(currentReportType);
                }
            }, (error) => {
                console.error("Error fetching tickets: ", error);
                showNotification('Error fetching tickets.', 'error');
            });

            // Online users collection listener
            const onlineUsersRef = collection(db, `/artifacts/${appId}/public/data/onlineUsers`);
            onSnapshot(onlineUsersRef, (snapshot) => {
                onlineUsers = {};
                snapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    // Only include users seen in the last 2 minutes
                    if (userData.lastSeen) {
                        const lastSeen = userData.lastSeen.toDate();
                        const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000);
                        if (lastSeen > twoMinutesAgo && userData.online !== false) {
                            onlineUsers[doc.id] = userData;
                        }
                    }
                });
                
                updateOnlineUsersDisplay();
            });
            
            // NEW: Turnover data listener
            const turnoverRef = doc(db, `/artifacts/${appId}/public/data/turnover`, 'current');
            onSnapshot(turnoverRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    turnoverData = {
                        ...turnoverData,
                        ...data
                    };
                    renderTurnoverData();
                }
            });
        }
        
        function showRealTimeUpdate() {
            updateMessage.textContent = 'Ticket data updated in real-time';
            realTimeIndicator.style.display = 'block';
            
            setTimeout(() => {
                realTimeIndicator.style.display = 'none';
            }, 3000);
        }
        
        function updateOnlineUsersDisplay() {
            const currentUserCount = Object.keys(onlineUsers).length;
            
            // Update user count in header
            document.querySelectorAll('.user-count').forEach(el => el.remove());
            
            const userCountBadge = document.createElement('span');
            userCountBadge.className = 'user-count bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full ml-2';
            userCountBadge.textContent = `${currentUserCount} online`;
            currentUserName.parentNode.appendChild(userCountBadge);
            
            // Update online users panel
            onlineUsersList.innerHTML = '';
            
            Object.values(onlineUsers).forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'online-user';
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.backgroundColor = generateUserColor(user.id);
                avatar.textContent = user.name.charAt(0).toUpperCase();
                
                const name = document.createElement('span');
                name.className = 'text-sm';
                name.textContent = user.name;
                
                const status = document.createElement('div');
                status.className = 'user-status';
                
                userEl.appendChild(avatar);
                userEl.appendChild(name);
                userEl.appendChild(status);
                onlineUsersList.appendChild(userEl);
            });
        }
        
        function setupOnlineUsersPanel() {
            let hideTimeout;
            
            currentUserName.parentNode.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
                onlineUsersPanel.classList.remove('hidden');
            });
            
            currentUserName.parentNode.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    onlineUsersPanel.classList.add('hidden');
                }, 500);
            });
            
            onlineUsersPanel.addEventListener('mouseenter', () => {
                clearTimeout(hideTimeout);
            });
            
            onlineUsersPanel.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    onlineUsersPanel.classList.add('hidden');
                }, 500);
            });
        }
        
        // --- OPTIMISTIC CONCURRENCY CONTROL ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const ticketId = document.getElementById('ticketId').value;
            const formData = new FormData(ticketForm);
            const ticketData = Object.fromEntries(formData.entries());
            const currentVersion = parseInt(document.getElementById('ticketVersion').value);

            // Check for edit conflicts
            if (ticketId) {
                const existingTicket = allTickets.find(t => t.id === ticketId);
                if (existingTicket && existingTicket._version > currentVersion) {
                    // Show conflict resolution modal
                    showEditConflictModal(ticketId, ticketData, existingTicket);
                    return;
                }
            }

            // If no conflict, proceed with save
            await saveTicketData(ticketId, ticketData, currentVersion);
        }
        
        function showEditConflictModal(ticketId, localData, serverData) {
            editingTicketId = ticketId;
            editConflictModal.classList.remove('hidden');
            
            // Set up conflict resolution buttons
            overwriteChangesBtn.onclick = () => {
                // Overwrite server changes with local changes
                saveTicketData(ticketId, localData, serverData._version);
                editConflictModal.classList.add('hidden');
            };
            
            reloadTicketBtn.onclick = () => {
                // Reload the server version into the form
                openModal(serverData);
                editConflictModal.classList.add('hidden');
            };
            
            cancelEditBtn.onclick = () => {
                // Just close the modal and form
                editConflictModal.classList.add('hidden');
                closeModal();
            };
        }
        
        async function saveTicketData(ticketId, ticketData, currentVersion) {
            // Add timestamps and version
            const isResolved = ticketData.status === 'Resolved';
            const wasPreviouslyResolved = ticketId ? allTickets.find(t => t.id === ticketId)?.status === 'Resolved' : false;

            ticketData.updatedAt = serverTimestamp();
            ticketData._version = (currentVersion || 0) + 1;
            
            if (isResolved && !wasPreviouslyResolved) {
                ticketData.resolvedAt = serverTimestamp();
            }

            try {
                if (ticketId) {
                    // Update existing ticket
                    const docRef = doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId);
                    await setDoc(docRef, ticketData, { merge: true });
                    showNotification('Ticket updated successfully!', 'success');
                } else {
                    // Create new ticket
                    ticketData.createdAt = serverTimestamp();
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/tickets`), ticketData);
                    showNotification('Ticket created successfully!', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving ticket: ", error);
                showNotification('Error saving ticket: ' + error.message, 'error');
            }
        }

        // --- UI RENDERING ---
        function renderTickets() {
            const inProgressTable = document.getElementById('in-progress-tickets-table');
            const resolvedTable = document.getElementById('resolved-tickets-table');
            
            // Display ALL tickets in both tabs by default
            let inProgressTickets = allTickets.filter(t => t.status !== 'Resolved');
            let resolvedTickets = allTickets.filter(t => t.status === 'Resolved');
            
            // Apply sorting (but don't filter by default)
            inProgressTickets = sortTickets(inProgressTickets, 'in-progress');
            resolvedTickets = sortTickets(resolvedTickets, 'resolved');
            
            // Apply pagination
            const inProgressTotalPages = Math.ceil(inProgressTickets.length / itemsPerPage);
            const resolvedTotalPages = Math.ceil(resolvedTickets.length / itemsPerPage);
            
            // Ensure current page is valid
            currentPageInProgress = Math.min(currentPageInProgress, Math.max(1, inProgressTotalPages));
            currentPageResolved = Math.min(currentPageResolved, Math.max(1, resolvedTotalPages));
            
            // Get current page items
            const inProgressStartIndex = (currentPageInProgress - 1) * itemsPerPage;
            const inProgressEndIndex = inProgressStartIndex + itemsPerPage;
            const inProgressPageItems = inProgressTickets.slice(inProgressStartIndex, inProgressEndIndex);
            
            const resolvedStartIndex = (currentPageResolved - 1) * itemsPerPage;
            const resolvedEndIndex = resolvedStartIndex + itemsPerPage;
            const resolvedPageItems = resolvedTickets.slice(resolvedStartIndex, resolvedEndIndex);
            
            // Render tables
            inProgressTable.innerHTML = inProgressPageItems.map(ticket => createInProgressRow(ticket)).join('');
            resolvedTable.innerHTML = resolvedPageItems.map(ticket => createResolvedRow(ticket)).join('');
            
            // Render pagination
            renderPagination('in-progress', inProgressTickets.length, currentPageInProgress, inProgressTotalPages);
            renderPagination('resolved', resolvedTickets.length, currentPageResolved, resolvedTotalPages);
            
            // Re-attach event listeners for dropdowns
            setupDropdownEventListeners();
        }
        
        function renderPagination(type, totalItems, currentPage, totalPages) {
            const paginationContainer = document.getElementById(`${type}-pagination`);
            
            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }
            
            paginationContainer.classList.remove('hidden');
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Previous</button>`;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust if we're at the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" data-page="1">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
            }
            
            // Next button
            paginationHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Next</button>`;
            
            // Info
            paginationHTML += `<span class="pagination-info">Showing ${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)}-${Math.min(currentPage * itemsPerPage, totalItems)} of ${totalItems}</span>`;
            
            paginationContainer.innerHTML = paginationHTML;
            
            // Add event listeners to pagination buttons
            paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!e.target.disabled) {
                        const page = parseInt(e.target.dataset.page);
                        if (type === 'in-progress') {
                            currentPageInProgress = page;
                        } else {
                            currentPageResolved = page;
                        }
                        renderTickets();
                    }
                });
            });
        }

        function createInProgressRow(ticket) {
            const age = ticket.createdAt ? formatDistanceToNow(ticket.createdAt.toDate()) : 'N/A';
            const status = ticket.status === 'Resolved' ? 'Resolved' : 'In Progress'; // Normalize status
            const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toLocaleDateString() : (ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A');
            
            // Truncate long text
            const shortIssueType = ticket.issueType ? (ticket.issueType.length > 30 ? ticket.issueType.substring(0, 30) + '...' : ticket.issueType) : '-';
            const shortDescription = ticket.description ? (ticket.description.length > 50 ? ticket.description.substring(0, 50) + '...' : ticket.description) : '-';
            const shortResolution = ticket.resolution ? (ticket.resolution.length > 50 ? ticket.resolution.substring(0, 50) + '...' : ticket.resolution) : '-';
            
            return `
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="py-3 px-4 text-xs text-gray-500">${ticketDate}</td>
                    <td class="py-3 px-4">${ticket.shift}</td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.handledBy}">${ticket.handledBy}</td>
                    <td class="py-3 px-4 font-mono truncate-cell" title="${ticket.ticketNumber}">${ticket.ticketNumber}</td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full priority-${ticket.priority}">${ticket.priority}</span></td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(status)}">${status}</span></td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.issueType || 'Not specified'}">${shortIssueType}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.description || 'No description'}">${shortDescription}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.resolution || 'No resolution yet'}">${shortResolution}</td>
                    <td class="py-3 px-4 text-xs text-gray-500">${age}</td>
                    <td class="py-3 px-4 relative">
                        <div class="dropdown-container relative inline-block">
                            <button class="ellipsis-btn text-gray-600 hover:text-blue-600 text-lg font-bold" data-id="${ticket.id}">…</button>
                            <div class="dropdown-menu">
                                <button class="dropdown-item edit" data-id="${ticket.id}">Edit</button>
                                <button class="dropdown-item resolve" data-id="${ticket.id}">Mark as Resolved</button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function createResolvedRow(ticket) {
            const resolvedDate = ticket.resolvedAt ? ticket.resolvedAt.toDate().toLocaleDateString() : 'N/A';
            const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toLocaleDateString() : (ticket.createdAt ? ticket.createdAt.toDate().toLocaleDateString() : 'N/A');
            
            // Truncate long text
            const shortIssueType = ticket.issueType ? (ticket.issueType.length > 30 ? ticket.issueType.substring(0, 30) + '...' : ticket.issueType) : '-';
            const shortDescription = ticket.description ? (ticket.description.length > 50 ? ticket.description.substring(0, 50) + '...' : ticket.description) : '-';
            const shortResolution = ticket.resolution ? (ticket.resolution.length > 50 ? ticket.resolution.substring(0, 50) + '...' : ticket.resolution) : '-';
            
            return `
                <tr class="hover:bg-gray-50 text-sm">
                    <td class="py-3 px-4 text-xs text-gray-500">${ticketDate}</td>
                    <td class="py-3 px-4">${ticket.shift}</td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.handledBy}">${ticket.handledBy}</td>
                    <td class="py-3 px-4 font-mono truncate-cell" title="${ticket.ticketNumber}">${ticket.ticketNumber}</td>
                    <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full priority-${ticket.priority}">${ticket.priority}</span></td>
                    <td class="py-3 px-4 truncate-cell" title="${ticket.issueType || 'Not specified'}">${shortIssueType}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.description || 'No description'}">${shortDescription}</td>
                    <td class="py-3 px-4 truncate-description" title="${ticket.resolution || 'No resolution'}">${shortResolution}</td>
                    <td class="py-3 px-4 text-xs text-gray-500">${resolvedDate}</td>
                    <td class="py-3 px-4 relative">
                        <div class="dropdown-container relative inline-block">
                            <button class="ellipsis-btn text-gray-600 hover:text-blue-600 text-lg font-bold" data-id="${ticket.id}">…</button>
                            <div class="dropdown-menu">
                                <button class="dropdown-item edit" data-id="${ticket.id}">View/Edit</button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        function setupDropdownEventListeners() {
            // Close all dropdowns when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown-container')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });

            // Ellipsis button click to show dropdown
            document.querySelectorAll('.ellipsis-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        if (menu !== e.target.nextElementSibling) {
                            menu.classList.remove('show');
                        }
                    });
                    // Toggle current dropdown
                    const dropdown = e.target.nextElementSibling;
                    dropdown.classList.toggle('show');
                });
            });

            // Edit option click
            document.querySelectorAll('.dropdown-item.edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const ticketId = e.target.dataset.id;
                    const ticket = allTickets.find(t => t.id === ticketId);
                    openModal(ticket);
                    // Close dropdown
                    e.target.closest('.dropdown-menu').classList.remove('show');
                });
            });

            // Resolve option click
            document.querySelectorAll('.dropdown-item.resolve').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const ticketId = e.target.dataset.id;
                    markAsResolved(ticketId);
                    // Close dropdown
                    e.target.closest('.dropdown-menu').classList.remove('show');
                });
            });
        }

        async function markAsResolved(ticketId) {
            try {
                const ticket = allTickets.find(t => t.id === ticketId);
                const docRef = doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId);
                await setDoc(docRef, {
                    status: 'Resolved',
                    resolvedAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    _version: (ticket._version || 0) + 1
                }, { merge: true });
                showNotification('Ticket marked as resolved!', 'success');
            } catch (error) {
                console.error("Error resolving ticket: ", error);
                showNotification('Error resolving ticket.', 'error');
            }
        }

        function populateStaticAssigneeDropdowns() {
            const inProgressDropdown = document.getElementById('sort-in-progress-assignee');
            const resolvedDropdown = document.getElementById('sort-resolved-assignee');
            const handledByDropdown = document.getElementById('handledBy');

            // Shuffle the assignees list for random order
            const shuffledAssignees = [...assigneesList].sort(() => Math.random() - 0.5);
            const options = shuffledAssignees.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Add assignee options to sorting dropdowns
            inProgressDropdown.innerHTML = '<option value="default">All Assignees</option>' + options;
            resolvedDropdown.innerHTML = '<option value="default">All Assignees</option>' + options;
            
            // Populate handledBy dropdown in modal with blank default
            handledByDropdown.innerHTML = '<option value="" disabled selected>Select Assignee</option>' + options;
        }

        // --- MODAL & FORM HANDLING ---
        function openModal(ticket = null) {
            ticketForm.reset();
            deleteTicketBtn.classList.add('hidden');
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ticketDate').value = today;
            
            if (ticket) {
                modalTitle.textContent = 'Edit Ticket';
                document.getElementById('ticketId').value = ticket.id;
                document.getElementById('ticketDate').value = ticket.ticketDate || today;
                document.getElementById('shift').value = ticket.shift;
                document.getElementById('handledBy').value = ticket.handledBy;
                document.getElementById('ticketNumber').value = ticket.ticketNumber;
                document.getElementById('priority').value = ticket.priority || '';
                document.getElementById('issueType').value = ticket.issueType || '';
                document.getElementById('description').value = ticket.description || '';
                document.getElementById('resolution').value = ticket.resolution || '';
                document.getElementById('status').value = ticket.status === 'Resolved' ? 'Resolved' : 'In Progress';
                document.getElementById('ticketVersion').value = ticket._version || 0;
                
                deleteTicketBtn.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'New Ticket';
                document.getElementById('ticketId').value = '';
                document.getElementById('ticketVersion').value = '0';
                // Clear all selections for new tickets
                document.getElementById('shift').value = '';
                document.getElementById('handledBy').value = '';
                document.getElementById('priority').value = '';
                document.getElementById('issueType').value = '';
                document.getElementById('status').value = '';
                // Date is already set to today above
                // Clear text areas
                document.getElementById('description').value = '';
                document.getElementById('resolution').value = '';
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            editingTicketId = null;
        }

        async function handleDeleteTicket() {
            const ticketId = document.getElementById('ticketId').value;
            if (ticketId) {
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/tickets`, ticketId));
                    showNotification('Ticket deleted.', 'warning');
                    closeModal();
                } catch(error) {
                     console.error("Error deleting ticket: ", error);
                     showNotification('Error deleting ticket.', 'error');
                }
            }
        }
        
        // --- SORTING ---
        function sortTickets(tickets, type) {
            const dateSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-date' : 'sort-resolved-date').value;
            const shiftSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-shift' : 'sort-resolved-shift').value;
            const assigneeSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-assignee' : 'sort-resolved-assignee').value;
            const prioritySort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-priority' : 'sort-resolved-priority').value;
            const issueSort = document.getElementById(type === 'in-progress' ? 'sort-in-progress-issue' : 'sort-resolved-issue').value;
            const specificDateFilter = document.getElementById(type === 'in-progress' ? 'filter-in-progress-specific-date' : 'filter-resolved-specific-date').value;
            
            let sorted = [...tickets];

            // Filter by specific date if selected
            if (specificDateFilter) {
                sorted = sorted.filter(t => {
                    const ticketDate = t.ticketDate ? new Date(t.ticketDate).toISOString().split('T')[0] : 
                                          (t.createdAt ? t.createdAt.toDate().toISOString().split('T')[0] : '');
                    return ticketDate === specificDateFilter;
                });
            }

            // Filter by shift (only if not default)
            if(shiftSort !== 'default') {
                sorted = sorted.filter(t => t.shift === shiftSort);
            }
            
            // Filter by assignee (only if not default)
            if(assigneeSort !== 'default') {
                sorted = sorted.filter(t => t.handledBy === assigneeSort);
            }
            
            // Filter by priority (only if not default)
            if(prioritySort !== 'default') {
                sorted = sorted.filter(t => t.priority === prioritySort);
            }
            
            // Filter by issue type (only if not default)
            if(issueSort !== 'default') {
                sorted = sorted.filter(t => t.issueType === issueSort);
            }
            
            // Sort by date (always apply date sorting)
            sorted.sort((a, b) => {
                // Use ticketDate if available, otherwise use createdAt
                const dateA = a.ticketDate ? new Date(a.ticketDate) : (a.createdAt?.toDate() || new Date(0));
                const dateB = b.ticketDate ? new Date(b.ticketDate) : (b.createdAt?.toDate() || new Date(0));
                return dateSort === 'newest' ? dateB - dateA : dateA - dateB;
            });
            
            return sorted;
        }

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
            
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            
            // NEW: Update turnover when switching to turnover tab
            if (tabName === 'turnover') {
                updateTurnoverTickets();
            }
            
            // Auto-generate daily report when switching to reports tab
            if (tabName === 'reports' && !currentReportType) {
                generateReport('daily');
            } else if (tabName === 'reports' && currentReportType) {
                // If already have a report type, refresh it
                generateReport(currentReportType);
            }
        }

        // --- NOTIFICATIONS ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-blue-500'; // info
            if (type === 'success') bgColor = 'bg-blue-600';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';

            toast.className = `toast text-white px-6 py-3 rounded-lg shadow-lg mb-2 ${bgColor}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // --- NEW: TURNOVER FUNCTIONALITY ---
        function initializeTurnover() {
            // Set default date to today
            turnoverDateInput.value = new Date().toISOString().split('T')[0];
            
            // Set up event listeners for turnover
            turnoverDateInput.addEventListener('change', updateTurnoverTickets);
            turnoverShiftSelect.addEventListener('change', updateTurnoverTickets);
            
            addScheduledEventBtn.addEventListener('click', addScheduledEvent);
            addGeneralInfoBtn.addEventListener('click', addGeneralInfo);
            addReminderBtn.addEventListener('click', addReminder);
            addOncallUpdateBtn.addEventListener('click', addOncallUpdate);
            
            // Allow Enter key to add items
            newScheduledEventInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addScheduledEvent();
            });
            newGeneralInfoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addGeneralInfo();
            });
            newReminderInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addReminder();
            });
            newOncallUpdateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addOncallUpdate();
            });
            
            takeTurnoverScreenshotBtn.addEventListener('click', takeTurnoverScreenshot);
        }
        
        function updateTurnoverTickets() {
            const selectedDate = turnoverDateInput.value;
            const selectedShift = turnoverShiftSelect.value;
            
            // Filter tickets by date and shift
            const inProgressTickets = allTickets.filter(ticket => {
                const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                  (ticket.createdAt ? ticket.createdAt.toDate().toISOString().split('T')[0] : '');
                return ticketDate === selectedDate && 
                       ticket.shift === selectedShift.replace(' Shift', '') && 
                       ticket.status !== 'Resolved';
            });
            
            const resolvedTickets = allTickets.filter(ticket => {
                const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                  (ticket.createdAt ? ticket.createdAt.toDate().toISOString().split('T')[0] : '');
                return ticketDate === selectedDate && 
                       ticket.shift === selectedShift.replace(' Shift', '') && 
                       ticket.status === 'Resolved';
            });
            
            // Update the display with counts only
            turnoverInProgressCount.innerHTML = `
                <div class="text-3xl font-bold text-blue-700">${inProgressTickets.length}</div>
                <div class="text-sm text-blue-600">Tickets</div>
            `;
            
            turnoverResolvedCount.innerHTML = `
                <div class="text-3xl font-bold text-green-700">${resolvedTickets.length}</div>
                <div class="text-sm text-green-600">Tickets</div>
            `;
        }
        
        function renderTurnoverData() {
            // Render scheduled events
            turnoverScheduledEvents.innerHTML = turnoverData.scheduledEvents.length > 0 ? 
                turnoverData.scheduledEvents.map((event, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${event}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="scheduledEvents" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="scheduledEvents" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No scheduled events</div>';
                
            // Render general information
            turnoverGeneralInfo.innerHTML = turnoverData.generalInfo.length > 0 ? 
                turnoverData.generalInfo.map((info, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${info}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="generalInfo" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="generalInfo" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No general information</div>';
                
            // Render reminders
            turnoverReminders.innerHTML = turnoverData.reminders.length > 0 ? 
                turnoverData.reminders.map((reminder, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${reminder}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="reminders" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="reminders" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No reminders</div>';
                
            // Render on-call updates
            turnoverOncallUpdates.innerHTML = turnoverData.onCallUpdates.length > 0 ? 
                turnoverData.onCallUpdates.map((update, index) => `
                    <div class="turnover-item">
                        <div class="turnover-item-content">${update}</div>
                        <div class="turnover-item-actions">
                            <button class="text-blue-600 hover:text-blue-800 edit-turnover-item" data-section="onCallUpdates" data-index="${index}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 delete-turnover-item" data-section="onCallUpdates" data-index="${index}">Delete</button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500 italic p-2">No on-call updates</div>';
                
            // Attach event listeners to the new buttons
            attachTurnoverItemEventListeners();
        }
        
        function attachTurnoverItemEventListeners() {
            // Edit buttons
            document.querySelectorAll('.edit-turnover-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    const index = parseInt(e.target.dataset.index);
                    editTurnoverItem(section, index);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('.delete-turnover-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    const index = parseInt(e.target.dataset.index);
                    deleteTurnoverItem(section, index);
                });
            });
        }
        
        async function addScheduledEvent() {
            const event = newScheduledEventInput.value.trim();
            if (event) {
                turnoverData.scheduledEvents.push(event);
                await saveTurnoverData();
                newScheduledEventInput.value = '';
                showNotification('Scheduled event added', 'success');
            }
        }
        
        async function addGeneralInfo() {
            const info = newGeneralInfoInput.value.trim();
            if (info) {
                turnoverData.generalInfo.push(info);
                await saveTurnoverData();
                newGeneralInfoInput.value = '';
                showNotification('General information added', 'success');
            }
        }
        
        async function addReminder() {
            const reminder = newReminderInput.value.trim();
            if (reminder) {
                turnoverData.reminders.push(reminder);
                await saveTurnoverData();
                newReminderInput.value = '';
                showNotification('Reminder added', 'success');
            }
        }
        
        async function addOncallUpdate() {
            const update = newOncallUpdateInput.value.trim();
            if (update) {
                turnoverData.onCallUpdates.push(update);
                await saveTurnoverData();
                newOncallUpdateInput.value = '';
                showNotification('On-call update added', 'success');
            }
        }
        
        function editTurnoverItem(section, index) {
            const currentValue = turnoverData[section][index];
            const newValue = prompt(`Edit ${section.replace(/([A-Z])/g, ' $1').toLowerCase()}:`, currentValue);
            
            if (newValue !== null && newValue.trim() !== '') {
                turnoverData[section][index] = newValue.trim();
                saveTurnoverData();
                showNotification('Item updated', 'success');
            }
        }
        
        async function deleteTurnoverItem(section, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                turnoverData[section].splice(index, 1);
                await saveTurnoverData();
                showNotification('Item deleted', 'warning');
            }
        }
        
        async function saveTurnoverData() {
            try {
                const turnoverRef = doc(db, `/artifacts/${appId}/public/data/turnover`, 'current');
                await setDoc(turnoverRef, turnoverData);
            } catch (error) {
                console.error("Error saving turnover data: ", error);
                showNotification('Error saving turnover data.', 'error');
            }
        }
        
        async function takeTurnoverScreenshot() {
            try {
                showNotification('Taking turnover screenshot...', 'info');
                
                // Add screenshot mode class to hide edit/delete buttons
                document.getElementById('turnover-content').classList.add('screenshot-mode');
                
                // Small delay to ensure CSS is applied
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Create a temporary container for the screenshot that includes date and shift info
                const tempContainer = document.createElement('div');
                tempContainer.style.padding = '20px';
                tempContainer.style.backgroundColor = '#ffffff';
                
                // Add header with date and shift information
                const headerSection = document.createElement('div');
                headerSection.style.marginBottom = '20px';
                headerSection.style.padding = '15px';
                headerSection.style.backgroundColor = '#1e3a8a';
                headerSection.style.color = 'white';
                headerSection.style.borderRadius = '8px';
                headerSection.style.textAlign = 'center';
                
                const date = document.getElementById('turnover-date').value;
                const shift = document.getElementById('turnover-shift').value;
                
                headerSection.innerHTML = `
                    <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: bold;">Turnover Report</h2>
                    <div style="display: flex; justify-content: center; gap: 30px; font-size: 16px;">
                        <div><strong>Date:</strong> ${date}</div>
                        <div><strong>Shift:</strong> ${shift}</div>
                    </div>
                `;
                
                // Clone the turnover content
                const turnoverContent = document.getElementById('turnover-content');
                const turnoverClone = turnoverContent.cloneNode(true);
                
                // Remove the screenshot button from the clone
                const screenshotBtn = turnoverClone.querySelector('#takeTurnoverScreenshotBtn');
                if (screenshotBtn) screenshotBtn.remove();
                
                // Append header and content to temp container
                tempContainer.appendChild(headerSection);
                tempContainer.appendChild(turnoverClone);
                
                // Add temp container to body (off-screen)
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                document.body.appendChild(tempContainer);
                
                // Use html2canvas to capture the temp container
                const canvas = await html2canvas(tempContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });
                
                // Remove temp container
                document.body.removeChild(tempContainer);
                
                // Convert canvas to image and download
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                const formattedDate = date || new Date().toISOString().split('T')[0];
                const formattedShift = shift ? shift.replace(' ', '_') : 'Day_Shift';
                link.download = `Turnover_${formattedDate}_${formattedShift}.png`;
                link.href = image;
                link.click();
                
                showNotification('Turnover screenshot downloaded!', 'success');
            } catch (error) {
                console.error('Error taking turnover screenshot:', error);
                showNotification('Error taking turnover screenshot.', 'error');
            } finally {
                // Remove screenshot mode class to show edit/delete buttons again
                document.getElementById('turnover-content').classList.remove('screenshot-mode');
                
                // Clean up any remaining temp containers
                const tempContainers = document.querySelectorAll('[style*="left: -9999px"]');
                tempContainers.forEach(container => container.remove());
            }
        }

        // --- REPORTS ---
        function generateReport(period) {
            // Store the current report type for real-time updates
            currentReportType = period;
            
            const now = new Date();
            const pastDate = new Date();
            if (period === 'daily') {
                pastDate.setDate(now.getDate() - 1);
            } else if (period === 'weekly') {
                pastDate.setDate(now.getDate() - 7);
            } else if (period === 'monthly') {
                pastDate.setMonth(now.getMonth() - 1);
            }

            const periodTickets = allTickets.filter(t => {
                // Use ticketDate if available, otherwise use createdAt
                const ticketDate = t.ticketDate ? new Date(t.ticketDate) : (t.createdAt?.toDate() || new Date(0));
                return ticketDate >= pastDate;
            });
            
            const resolvedInPeriod = periodTickets.filter(t => t.status === 'Resolved' && t.resolvedAt && t.resolvedAt.toDate() >= pastDate);
            const inProgressInPeriod = periodTickets.filter(t => t.status !== 'Resolved');

            const totalResolved = resolvedInPeriod.length;
            const totalInProgress = inProgressInPeriod.length;
            
            const dayTickets = periodTickets.filter(t => t.shift === 'Day').length;
            const nightTickets = periodTickets.filter(t => t.shift === 'Night').length;

            const totalAgeInProgressMs = inProgressInPeriod.reduce((acc, t) => {
                return acc + (new Date() - (t.ticketDate ? new Date(t.ticketDate) : t.createdAt.toDate()));
            }, 0);
            const avgAgeInProgress = totalInProgress > 0 ? formatDuration(totalAgeInProgressMs / totalInProgress) : 'N/A';
            
            // Calculate issue type distribution
            const issueTypes = [
                'Zena Failed Jobs - BPI',
                'Zena Failed Jobs - DB',
                'Netcool Alert',
                'PagerDuty Alert',
                'PowerBroker (SDDC)',
                'PowerBroker (Cloud AWS)',
                'CSOC - Phishing Email',
                'Service Request - Data Center Access'
            ];
            
            const issueTypeCounts = {};
            issueTypes.forEach(issue => {
                issueTypeCounts[issue] = periodTickets.filter(t => t.issueType === issue).length;
            });
            
            // Calculate priority distribution
            const priorities = ['P1', 'P2', 'P3', 'P4'];
            const priorityCounts = {};
            priorities.forEach(priority => {
                priorityCounts[priority] = periodTickets.filter(t => t.priority === priority).length;
            });
            
            // Get period display information
            let periodDisplay = '';
            if (period === 'daily') {
                periodDisplay = `Daily Report - ${now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            } else if (period === 'weekly') {
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                const endOfWeek = new Date(now);
                endOfWeek.setDate(now.getDate() + (6 - now.getDay())); // Saturday
                
                periodDisplay = `Weekly Report - Week of ${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} to ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            } else if (period === 'monthly') {
                periodDisplay = `Monthly Report - ${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            }
            
            // Update the period display
            reportPeriodDisplay.innerHTML = periodDisplay;
            reportPeriodDisplay.classList.remove('hidden');
            
            // Show screenshot button
            takeScreenshotBtn.classList.remove('hidden');
            
            reportData = {
                period,
                totalResolved,
                totalInProgress,
                dayTickets,
                nightTickets,
                avgAgeInProgress,
                issueTypeCounts,
                priorityCounts,
                resolvedList: resolvedInPeriod.map(t => ({...t, 
                    createdAt: t.createdAt.toDate().toISOString(), 
                    resolvedAt: t.resolvedAt.toDate().toISOString(),
                    ticketDate: t.ticketDate || t.createdAt.toDate().toISOString().split('T')[0]
                })),
                inProgressList: inProgressInPeriod.map(t => ({...t, 
                    createdAt: t.createdAt.toDate().toISOString(),
                    ticketDate: t.ticketDate || t.createdAt.toDate().toISOString().split('T')[0]
                }))
            };

            renderReport(reportData, periodDisplay);
            
            // Show real-time indicator for report updates
            if (document.getElementById('reports-content').classList.contains('hidden') === false) {
                showNotification('Report updated with latest data', 'info');
            }
        }

        let charts = [];
        function renderReport(data, periodDisplay) {
            const output = document.getElementById('report-output');
            output.innerHTML = '';
            charts.forEach(chart => chart.destroy()); // Clear previous charts
            charts = [];

            // Stats cards
            const stats = [
                { label: 'Total Resolved', value: data.totalResolved, color: 'bg-green-100' },
                { label: 'Total In Progress', value: data.totalInProgress, color: 'bg-blue-100' },
                { label: 'Avg. In Progress Age', value: data.avgAgeInProgress, color: 'bg-sky-100' },
            ];
            
            stats.forEach(stat => {
                output.innerHTML += `
                    <div class="p-4 rounded-lg shadow ${stat.color}">
                        <h3 class="text-gray-500 text-sm font-medium">${stat.label}</h3>
                        <p class="text-2xl font-semibold">${stat.value}</p>
                    </div>`;
            });

            // Shift Breakdown Chart
            const shiftChartContainer = document.createElement('div');
            shiftChartContainer.className = "p-4 rounded-lg shadow bg-gray-50";
            shiftChartContainer.innerHTML = '<div class="chart-container"><canvas id="shiftChart"></canvas></div>';
            output.appendChild(shiftChartContainer);
            
            const shiftCtx = document.getElementById('shiftChart').getContext('2d');
            charts.push(new Chart(shiftCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Day Shift', 'Night Shift'],
                    datasets: [{
                        data: [data.dayTickets, data.nightTickets],
                        backgroundColor: ['#60a5fa', '#1e40af'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, title: { display: true, text: 'Tickets by Shift' } }
                }
            }));
            
             // Status Breakdown Chart
            const statusChartContainer = document.createElement('div');
            statusChartContainer.className = "p-4 rounded-lg shadow bg-gray-50";
            statusChartContainer.innerHTML = '<div class="chart-container"><canvas id="statusChart"></canvas></div>';
            output.appendChild(statusChartContainer);
            
            const statusData = { 'Resolved': data.totalResolved, 'In Progress': data.totalInProgress };
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            charts.push(new Chart(statusCtx, {
                type: 'bar',
                data: {
                    labels: ['Resolved', 'In Progress'],
                    datasets: [{
                        label: 'Ticket Count',
                        data: [statusData['Resolved'], statusData['In Progress']],
                        backgroundColor: ['#4ade80', '#60a5fa'],
                    }]
                },
                 options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Ticket Status Overview' } }
                }
            }));

            // Issue Type Distribution Chart
            const issueChartContainer = document.createElement('div');
            issueChartContainer.className = "p-4 rounded-lg shadow bg-gray-50";
            issueChartContainer.innerHTML = '<div class="chart-container"><canvas id="issueChart"></canvas></div>';
            output.appendChild(issueChartContainer);
            
            const issueTypes = Object.keys(data.issueTypeCounts);
            const issueCounts = Object.values(data.issueTypeCounts);
            
            // Create a color palette for issue types
            const issueColors = [
                '#3b82f6', '#1d4ed8', '#60a5fa', '#93c5fd',
                '#10b981', '#047857', '#f59e0b', '#d97706'
            ];
            
            const issueCtx = document.getElementById('issueChart').getContext('2d');
            charts.push(new Chart(issueCtx, {
                type: 'bar',
                data: {
                    labels: issueTypes,
                    datasets: [{
                        label: 'Number of Tickets',
                        data: issueCounts,
                        backgroundColor: issueColors,
                        borderColor: issueColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bar chart for better readability
                    plugins: {
                        legend: { display: false },
                        title: { 
                            display: true, 
                            text: `Issue/Request Distribution`
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            }));

            // Priority Distribution Chart
            const priorityChartContainer = document.createElement('div');
            priorityChartContainer.className = "p-4 rounded-lg shadow bg-gray-50";
            priorityChartContainer.innerHTML = '<div class="chart-container"><canvas id="priorityChart"></canvas></div>';
            output.appendChild(priorityChartContainer);
            
            const priorities = Object.keys(data.priorityCounts);
            const priorityCounts = Object.values(data.priorityCounts);
            
            // Priority colors matching the CSS classes
            const priorityColors = {
                'P1': '#fee2e2',
                'P2': '#fed7aa', 
                'P3': '#fef08a',
                'P4': '#dbeafe'
            };
            
            const priorityBorderColors = {
                'P1': '#dc2626',
                'P2': '#ea580c',
                'P3': '#ca8a04',
                'P4': '#1d4ed8'
            };
            
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            charts.push(new Chart(priorityCtx, {
                type: 'doughnut',
                data: {
                    labels: priorities,
                    datasets: [{
                        data: priorityCounts,
                        backgroundColor: priorities.map(p => priorityColors[p]),
                        borderColor: priorities.map(p => priorityBorderColors[p]),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { 
                            display: true, 
                            text: 'Priority Distribution'
                        }
                    }
                }
            }));

            // Trend Chart - Now matching the size of other charts
            const trendChartContainer = document.createElement('div');
            trendChartContainer.className = "p-4 rounded-lg shadow bg-gray-50";
            trendChartContainer.innerHTML = '<div class="chart-container"><canvas id="trendChart"></canvas></div>';
            output.appendChild(trendChartContainer);
            
            // Calculate trends based on period
            const trendData = calculateTrendData(data.period, data.resolvedList.concat(data.inProgressList));
            
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            charts.push(new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Tickets Created',
                        data: trendData.values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { 
                            display: true, 
                            text: `Ticket Trend - ${data.period.charAt(0).toUpperCase() + data.period.slice(1)}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            }));

            document.getElementById('downloadReportBtn').classList.remove('hidden');
        }
        
        function calculateTrendData(period, tickets) {
            const now = new Date();
            const labels = [];
            const values = [];
            
            if (period === 'daily') {
                // Last 24 hours in 4-hour intervals
                for (let i = 5; i >= 0; i--) {
                    const startHour = i * 4;
                    const endHour = (i + 1) * 4;
                    const currentHour = new Date().getHours();
                    
                    let label;
                    if (i === 5) {
                        label = `Now (${currentHour}:00)`;
                    } else {
                        label = `${startHour}:00 - ${endHour}:00`;
                    }
                    
                    labels.push(label);
                    
                    const count = tickets.filter(ticket => {
                        const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate) : new Date(ticket.createdAt);
                        const ticketHour = ticketDate.getHours();
                        return ticketHour >= startHour && ticketHour < endHour && 
                               ticketDate.toDateString() === now.toDateString();
                    }).length;
                    
                    values.push(count);
                }
            } else if (period === 'weekly') {
                // Last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(now.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
                    
                    const count = tickets.filter(ticket => {
                        const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate).toISOString().split('T')[0] : 
                                            ticket.createdAt.split('T')[0];
                        return ticketDate === dateStr;
                    }).length;
                    
                    values.push(count);
                }
            } else if (period === 'monthly') {
                // Last 4 weeks
                for (let i = 3; i >= 0; i--) {
                    const startDate = new Date();
                    startDate.setDate(now.getDate() - (i + 1) * 7);
                    const endDate = new Date();
                    endDate.setDate(now.getDate() - i * 7);
                    
                    labels.push(`Week ${4 - i}`);
                    
                    const count = tickets.filter(ticket => {
                        const ticketDate = ticket.ticketDate ? new Date(ticket.ticketDate) : new Date(ticket.createdAt);
                        return ticketDate >= startDate && ticketDate < endDate;
                    }).length;
                    
                    values.push(count);
                }
            }
            
            return { labels, values };
        }
        
        function downloadReport() {
            if (!reportData) {
                showNotification('Please generate a report first.', 'warning');
                return;
            }
            
            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const summary = [
                ["Report Period", reportData.period],
                ["Total Resolved", reportData.totalResolved],
                ["Total In Progress", reportData.totalInProgress],
                ["Day Shift Tickets", reportData.dayTickets],
                ["Night Shift Tickets", reportData.nightTickets],
                ["Average In Progress Age", reportData.avgAgeInProgress],
            ];
            
            // Add issue type breakdown to summary
            summary.push(["", ""]);
            summary.push(["Issue Type Breakdown", ""]);
            Object.entries(reportData.issueTypeCounts).forEach(([issue, count]) => {
                summary.push([issue, count]);
            });

            // Add priority breakdown to summary
            summary.push(["", ""]);
            summary.push(["Priority Breakdown", ""]);
            Object.entries(reportData.priorityCounts).forEach(([priority, count]) => {
                summary.push([priority, count]);
            });
            
            const wsSummary = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // In Progress Sheet
            const wsInProgress = XLSX.utils.json_to_sheet(reportData.inProgressList);
            XLSX.utils.book_append_sheet(wb, wsInProgress, "In Progress Tickets");
            
            // Resolved Sheet
            const wsResolved = XLSX.utils.json_to_sheet(reportData.resolvedList);
            XLSX.utils.book_append_sheet(wb, wsResolved, "Resolved Tickets");
            
            XLSX.writeFile(wb, `Ticket_Report_${reportData.period}_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Report downloaded!', 'success');
        }

        // --- SCREENSHOT FUNCTIONALITY ---
        async function takeScreenshot() {
            if (!reportData) {
                showNotification('Please generate a report first.', 'warning');
                return;
            }

            try {
                showNotification('Taking screenshot...', 'info');
                
                // Get the report content to capture
                const reportContent = document.getElementById('report-screenshot-content');
                
                // Use html2canvas to capture the report content
                const canvas = await html2canvas(reportContent, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });
                
                // Convert canvas to image and download
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `Ticket_Report_${reportData.period}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = image;
                link.click();
                
                showNotification('Screenshot downloaded!', 'success');
            } catch (error) {
                console.error('Error taking screenshot:', error);
                showNotification('Error taking screenshot.', 'error');
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            addTicketBtn.addEventListener('click', () => openModal());
            cancelModalBtn.addEventListener('click', closeModal);
            ticketForm.addEventListener('submit', handleFormSubmit);
            deleteTicketBtn.addEventListener('click', handleDeleteTicket);

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });
            
            document.querySelectorAll('.sort-control').forEach(el => {
                el.addEventListener('change', () => {
                    // Reset to first page when filters change
                    currentPageInProgress = 1;
                    currentPageResolved = 1;
                    renderTickets();
                });
            });
            
            // Add event listeners for date pickers
            document.getElementById('filter-in-progress-specific-date').addEventListener('change', () => {
                currentPageInProgress = 1;
                renderTickets();
            });
            document.getElementById('filter-resolved-specific-date').addEventListener('change', () => {
                currentPageResolved = 1;
                renderTickets();
            });
            
            // Report buttons - now update currentReportType
            document.getElementById('generateDailyReportBtn').addEventListener('click', () => generateReport('daily'));
            document.getElementById('generateWeeklyReportBtn').addEventListener('click', () => generateReport('weekly'));
            document.getElementById('generateMonthlyReportBtn').addEventListener('click', () => generateReport('monthly'));
            document.getElementById('downloadReportBtn').addEventListener('click', downloadReport);
            document.getElementById('takeScreenshotBtn').addEventListener('click', takeScreenshot);
        }

        // --- HELPER FUNCTIONS ---
        function getStatusColor(status) {
            switch (status) {
                case 'In Progress':
                case 'New':
                case 'Investigating':
                case 'On-Hold':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Resolved': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDistanceToNow(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }
        
        function formatDuration(ms) {
            if (ms < 0) ms = -ms;
            const time = {
                day: Math.floor(ms / 86400000),
                hour: Math.floor(ms / 3600000) % 24,
                minute: Math.floor(ms / 60000) % 60,
            };
            return Object.entries(time)
                .filter(val => val[1] !== 0)
                .map(([key, val]) => `${val} ${key}${val !== 1 ? 's' : ''}`)
                .join(', ');
        }

        // Initialize the app immediately
        initApp();
    </script>

</body>
</html>